# ğŸ“… OkHttpæºç 7å¤©é€Ÿæˆè·¯çº¿å›¾

> **ç›®æ ‡**ï¼š7å¤©æ·±å…¥ç†è§£OkHttpæºç ï¼Œèƒ½å¤Ÿç‹¬ç«‹å®ç°ç®€åŒ–ç‰ˆOkHttp

---

## ğŸ“Š å­¦ä¹ æ¦‚è§ˆ

| å¤©æ•° | ä¸»é¢˜ | æ ¸å¿ƒå†…å®¹ | é¢„è®¡æ—¶é—´ | éš¾åº¦ |
|------|------|---------|---------|------|
| Day 1 | åŸºç¡€æ•°æ®ç±» | Request/Response/RequestBody/ResponseBody | 2-3å°æ—¶ | â­â­â˜†â˜†â˜† |
| Day 2 | æ ¸å¿ƒæ¥å£ä¸é“¾ | Call/Interceptor/RealInterceptorChain | 3-4å°æ—¶ | â­â­â­â­â­ |
| Day 3 | å®¢æˆ·ç«¯ä¸æ‰§è¡Œ | OkHttpClient/RealCall | 2-3å°æ—¶ | â­â­â­â˜†â˜† |
| Day 4 | æ‹¦æˆªå™¨ï¼ˆä¸Šï¼‰ | BridgeInterceptor/RetryAndFollowUp | 2-3å°æ—¶ | â­â­â­â­â˜† |
| Day 5 | æ‹¦æˆªå™¨ï¼ˆä¸‹ï¼‰ | ConnectInterceptor/CallServerInterceptor | 3-4å°æ—¶ | â­â­â­â­â­ |
| Day 6 | è¿æ¥ç®¡ç† | RealConnection/ConnectionPool | 2-3å°æ—¶ | â­â­â­â­â˜† |
| Day 7 | è°ƒåº¦ä¸æ€»ç»“ | Dispatcher/ç»¼åˆç»ƒä¹  | 2-3å°æ—¶ | â­â­â­â­â˜† |

**æ€»è®¡**ï¼šçº¦15-20å°æ—¶

---

## ğŸ“… Day 1ï¼šåŸºç¡€æ•°æ®ç±»ï¼ˆè½»æ¾å¼€å±€ï¼‰

### ğŸ¯ å­¦ä¹ ç›®æ ‡
- ç†è§£HTTPè¯·æ±‚å’Œå“åº”çš„ç»“æ„
- æŒæ¡Builderæ¨¡å¼çš„ä½¿ç”¨
- ç†è§£ä¸å¯å˜å¯¹è±¡çš„å¥½å¤„

### ğŸ“š å­¦ä¹ å†…å®¹

#### ä¸Šåˆï¼ˆ1-1.5å°æ—¶ï¼‰ï¼šRequestBody & ResponseBody

**1. RequestBodyï¼ˆ30åˆ†é’Ÿï¼‰**
```java
// æ‰“å¼€æ¨¡æ¿ï¼š01_RequestBody_æ¨¡æ¿.java
// å­¦ä¹ é‡ç‚¹ï¼š
// - ä¸ºä»€ä¹ˆè®¾è®¡æˆæŠ½è±¡ç±»ï¼Ÿ
// - contentType()å’ŒwriteTo()çš„ä½œç”¨
// - å¦‚ä½•æ‰©å±•ä¸åŒç±»å‹çš„è¯·æ±‚ä½“ï¼ˆString/JSON/Fileï¼‰
```

**å®æˆ˜ä»»åŠ¡**ï¼š
```java
// å®ç°ä¸€ä¸ªJsonRequestBody
public class JsonRequestBody extends RequestBody {
    private String json;
    
    public JsonRequestBody(String json) {
        this.json = json;
    }
    
    @Override
    public String contentType() {
        return "application/json";
    }
    
    @Override
    public void writeTo(OutputStream out) throws IOException {
        out.write(json.getBytes("UTF-8"));
    }
}

// æµ‹è¯•
RequestBody body = new JsonRequestBody("{\"name\":\"test\"}");
System.out.println(body.contentType());  // application/json
```

**2. ResponseBodyï¼ˆ30åˆ†é’Ÿï¼‰**
```java
// æ‰“å¼€æ¨¡æ¿ï¼š02_ResponseBody_æ¨¡æ¿.java
// å­¦ä¹ é‡ç‚¹ï¼š
// - ä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜bytesï¼Ÿ
// - string()æ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡çš„åŸå› 
// - å¦‚ä½•å¤„ç†å¤§æ–‡ä»¶å“åº”
```

**å®æˆ˜ä»»åŠ¡**ï¼šå®ç°ResponseBodyå¹¶æµ‹è¯•string()æ–¹æ³•

#### ä¸‹åˆï¼ˆ1-1.5å°æ—¶ï¼‰ï¼šRequest & Response

**1. Requestï¼ˆ45åˆ†é’Ÿï¼‰**
```java
// æ‰“å¼€æ¨¡æ¿ï¼š03_Request_æ¨¡æ¿.java
// å­¦ä¹ é‡ç‚¹ï¼š
// - Builderæ¨¡å¼çš„ä¼˜ç‚¹
// - ä¸å¯å˜å¯¹è±¡çš„è®¾è®¡
// - é“¾å¼è°ƒç”¨çš„å®ç°
```

**å®æˆ˜ä»»åŠ¡**ï¼š
```java
// åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„POSTè¯·æ±‚
Request request = new Request.Builder()
    .url("http://api.example.com/users")
    .method("POST", body)
    .header("Authorization", "Bearer token")
    .header("Content-Type", "application/json")
    .build();

// éªŒè¯å„ä¸ªå­—æ®µ
System.out.println("URL: " + request.url());
System.out.println("æ–¹æ³•: " + request.method());
System.out.println("Authorization: " + request.header("Authorization"));
```

**2. Responseï¼ˆ45åˆ†é’Ÿï¼‰**
```java
// æ‰“å¼€æ¨¡æ¿ï¼š04_Response_æ¨¡æ¿.java
// å­¦ä¹ é‡ç‚¹ï¼š
// - ä¸Requestçš„ç›¸ä¼¼æ€§
// - çŠ¶æ€ç çš„å¤„ç†
// - å“åº”å¤´çš„ç®¡ç†
```

### âœ… Day 1 æ£€æŸ¥ç‚¹
- [ ] ç†è§£Builderæ¨¡å¼çš„ä¼˜åŠ¿
- [ ] èƒ½å¤Ÿåˆ›å»ºRequestå’ŒResponseå¯¹è±¡
- [ ] ç†è§£ä¸ºä»€ä¹ˆResponseBody.string()åªèƒ½è°ƒç”¨ä¸€æ¬¡
- [ ] å®Œæˆå®æˆ˜ä»»åŠ¡

### ğŸ“ Day 1 ä½œä¸š
1. å®ç°ä¸€ä¸ªFileRequestBodyï¼Œèƒ½å¤Ÿå‘é€æ–‡ä»¶
2. ä½¿ç”¨Builderåˆ›å»º5ä¸ªä¸åŒçš„Request
3. é˜…è¯»ã€Šå®æˆ˜ç»ƒä¹ é¢˜.mdã€‹çš„ç»ƒä¹ 1å’Œç»ƒä¹ 2

---

## ğŸ“… Day 2ï¼šæ ¸å¿ƒæ¥å£ä¸é“¾ï¼ˆå…³é”®ä¸€å¤©ï¼ï¼‰â­â­â­â­â­

### ğŸ¯ å­¦ä¹ ç›®æ ‡
- **æ·±åˆ»ç†è§£è´£ä»»é“¾æ¨¡å¼**ï¼ˆæœ€é‡è¦ï¼ï¼‰
- æŒæ¡é€’å½’è°ƒç”¨åŸç†
- ç†è§£æ‹¦æˆªå™¨çš„å·¥ä½œæœºåˆ¶

### ğŸ“š å­¦ä¹ å†…å®¹

#### ä¸Šåˆï¼ˆ1.5-2å°æ—¶ï¼‰ï¼šCall & Interceptor

**1. Callæ¥å£ï¼ˆ30åˆ†é’Ÿï¼‰**
```java
// æ‰“å¼€æ¨¡æ¿ï¼š05_Call_æ¨¡æ¿.java
// å­¦ä¹ é‡ç‚¹ï¼š
// - execute()å’Œenqueue()çš„åŒºåˆ«
// - åŒæ­¥vså¼‚æ­¥çš„åº”ç”¨åœºæ™¯
```

**2. Interceptoræ¥å£ï¼ˆ1å°æ—¶ï¼‰**
```java
// æ‰“å¼€æ¨¡æ¿ï¼š06_Interceptor_æ¨¡æ¿.java
// å­¦ä¹ é‡ç‚¹ï¼š
// - æ‹¦æˆªå™¨çš„ä½œç”¨
// - Chainçš„å«ä¹‰
// - chain.proceed()çš„ä½œç”¨
```

**å®æˆ˜ä»»åŠ¡**ï¼šå®ç°ä¸€ä¸ªç®€å•çš„æ—¥å¿—æ‹¦æˆªå™¨
```java
public class LoggingInterceptor implements Interceptor {
    @Override
    public Response intercept(Chain chain) throws IOException {
        Request request = chain.request();
        System.out.println("è¯·æ±‚: " + request.url());
        
        Response response = chain.proceed(request);
        
        System.out.println("å“åº”: " + response.code());
        return response;
    }
}
```

#### ä¸‹åˆï¼ˆ1.5-2å°æ—¶ï¼‰ï¼šRealInterceptorChain â­â­â­â­â­

**è¿™æ˜¯ä»Šå¤©æœ€é‡è¦çš„å†…å®¹ï¼**

```java
// æ‰“å¼€æ¨¡æ¿ï¼š07_RealInterceptorChain_æ¨¡æ¿.java
// ä»”ç»†é˜…è¯»æ¯ä¸€è¡Œæ³¨é‡Šï¼
```

**å­¦ä¹ é‡ç‚¹**ï¼š
1. **é€’å½’è°ƒç”¨çš„åŸç†**
```
Chain0.proceed() 
  â†’ è°ƒç”¨ Interceptor0.intercept(Chain1)
    â†’ Chain1.proceed()
      â†’ è°ƒç”¨ Interceptor1.intercept(Chain2)
        â†’ Chain2.proceed()
          â†’ ...
```

2. **indexçš„ä½œç”¨**
```
Chain0: index=0 â†’ æ‰§è¡Œ interceptors[0]
Chain1: index=1 â†’ æ‰§è¡Œ interceptors[1]
Chain2: index=2 â†’ æ‰§è¡Œ interceptors[2]
```

3. **ä¸ºä»€ä¹ˆæ˜¯è´£ä»»é“¾ï¼Ÿ**
```
æ¯ä¸ªæ‹¦æˆªå™¨ï¼š
1. å¤„ç†è‡ªå·±è´Ÿè´£çš„éƒ¨åˆ†
2. è°ƒç”¨chain.proceed()ä¼ é€’ç»™ä¸‹ä¸€ä¸ª
3. æ¥æ”¶ä¸‹ä¸€ä¸ªçš„è¿”å›å€¼
4. å¯ä»¥ä¿®æ”¹è¿”å›å€¼
```

**å®æˆ˜ä»»åŠ¡**ï¼šç”»å‡ºæ‹¦æˆªå™¨è°ƒç”¨æµç¨‹å›¾
```
è¯·æ±‚ â†’
  LogInterceptor (æ‰“å°è¯·æ±‚ä¿¡æ¯)
    â†’ RetryInterceptor (é‡è¯•é€»è¾‘)
      â†’ NetworkInterceptor (ç½‘ç»œè¯·æ±‚)
        â†’ è¿”å›Response
      â† æ£€æŸ¥æ˜¯å¦éœ€è¦é‡è¯•
    â† æ‰“å°å“åº”ä¿¡æ¯
â† è¿”å›Response
```

**è°ƒè¯•ç»ƒä¹ **ï¼š
```java
// åˆ›å»º3ä¸ªç®€å•çš„æ‹¦æˆªå™¨
Interceptor inter1 = chain -> {
    System.out.println("Inter1: before");
    Response response = chain.proceed(chain.request());
    System.out.println("Inter1: after");
    return response;
};

Interceptor inter2 = chain -> {
    System.out.println("Inter2: before");
    Response response = chain.proceed(chain.request());
    System.out.println("Inter2: after");
    return response;
};

Interceptor inter3 = chain -> {
    System.out.println("Inter3: before");
    // è¿™é‡Œä¸è°ƒç”¨proceedï¼Œç›´æ¥è¿”å›æ¨¡æ‹Ÿå“åº”
    System.out.println("Inter3: after");
    return mockResponse;
};

// è¾“å‡ºåº”è¯¥æ˜¯ï¼š
// Inter1: before
// Inter2: before
// Inter3: before
// Inter3: after
// Inter2: after
// Inter1: after
```

### âœ… Day 2 æ£€æŸ¥ç‚¹
- [ ] èƒ½å¤Ÿç”»å‡ºæ‹¦æˆªå™¨è°ƒç”¨æµç¨‹å›¾
- [ ] ç†è§£é€’å½’è°ƒç”¨çš„åŸç†
- [ ] ç†è§£indexçš„ä½œç”¨
- [ ] èƒ½å¤Ÿå®ç°è‡ªå®šä¹‰æ‹¦æˆªå™¨
- [ ] å®Œæˆè°ƒè¯•ç»ƒä¹ 

### ğŸ“ Day 2 ä½œä¸š
1. ç”»å‡º3ä¸ªæ‹¦æˆªå™¨çš„å®Œæ•´è°ƒç”¨æµç¨‹å›¾ï¼ˆåŒ…æ‹¬è°ƒç”¨æ ˆï¼‰
2. å®ç°ä¸€ä¸ªè®¡æ—¶æ‹¦æˆªå™¨ï¼Œæµ‹é‡è¯·æ±‚è€—æ—¶
3. é˜…è¯»ã€Šå®æˆ˜ç»ƒä¹ é¢˜.mdã€‹çš„ç»ƒä¹ 3å’Œç»ƒä¹ 5
4. **é‡è¦**ï¼šåå¤é˜…è¯»07_RealInterceptorChain_æ¨¡æ¿.javaï¼Œç›´åˆ°å®Œå…¨ç†è§£

---

## ğŸ“… Day 3ï¼šå®¢æˆ·ç«¯ä¸æ‰§è¡Œï¼ˆä¸²è”èµ·æ¥ï¼‰

### ğŸ¯ å­¦ä¹ ç›®æ ‡
- ç†è§£OkHttpClientçš„ä½œç”¨
- æŒæ¡åŒæ­¥å’Œå¼‚æ­¥æ‰§è¡Œçš„å®ç°
- ç†è§£æ•´ä¸ªè¯·æ±‚æµç¨‹

### ğŸ“š å­¦ä¹ å†…å®¹

#### ä¸Šåˆï¼ˆ1-1.5å°æ—¶ï¼‰ï¼šOkHttpClient

```java
// æ‰“å¼€æ¨¡æ¿ï¼š08_OkHttpClient_æ¨¡æ¿.java
// å­¦ä¹ é‡ç‚¹ï¼š
// - ä¸ºä»€ä¹ˆæ¨èå…¨å±€å•ä¾‹ï¼Ÿ
// - Builderæ¨¡å¼çš„å¤ç”¨
// - æ‹¦æˆªå™¨çš„æ·»åŠ é¡ºåº
```

**å®æˆ˜ä»»åŠ¡**ï¼š
```java
// åˆ›å»ºä¸€ä¸ªé…ç½®å®Œæ•´çš„Client
OkHttpClient client = new OkHttpClient.Builder()
    .connectTimeout(10000)
    .readTimeout(10000)
    .writeTimeout(10000)
    .addInterceptor(new LoggingInterceptor())
    .build();

// éªŒè¯é…ç½®
System.out.println("è¿æ¥è¶…æ—¶: " + client.connectTimeoutMillis());
System.out.println("æ‹¦æˆªå™¨æ•°é‡: " + client.interceptors().size());
```

#### ä¸‹åˆï¼ˆ1-1.5å°æ—¶ï¼‰ï¼šRealCall

```java
// æ‰“å¼€æ¨¡æ¿ï¼š09_RealCall_æ¨¡æ¿.java
// å­¦ä¹ é‡ç‚¹ï¼š
// - execute()çš„å®ç°ï¼ˆåŒæ­¥ï¼‰
// - enqueue()çš„å®ç°ï¼ˆå¼‚æ­¥ï¼‰
// - AsyncCallçš„ä½œç”¨
```

**å…³é”®ä»£ç **ï¼š
```java
// åŒæ­¥æ‰§è¡Œ
public Response execute() throws IOException {
    // 1. é€šçŸ¥Dispatcher
    client.dispatcher().executed(this);
    
    try {
        // 2. æ„å»ºæ‹¦æˆªå™¨é“¾
        // 3. æ‰§è¡Œæ‹¦æˆªå™¨é“¾
        return getResponseWithInterceptorChain();
    } finally {
        // 4. é€šçŸ¥å®Œæˆ
        client.dispatcher().finished(this);
    }
}

// å¼‚æ­¥æ‰§è¡Œ
public void enqueue(Callback callback) {
    // 1. åˆ›å»ºAsyncCall
    AsyncCall asyncCall = new AsyncCall(callback);
    
    // 2. æäº¤åˆ°Dispatcher
    client.dispatcher().enqueue(asyncCall);
}
```

**å®æˆ˜ä»»åŠ¡**ï¼šæµ‹è¯•åŒæ­¥å’Œå¼‚æ­¥è¯·æ±‚
```java
// åŒæ­¥è¯·æ±‚
Response response = client.newCall(request).execute();
System.out.println("åŒæ­¥ç»“æœ: " + response.code());

// å¼‚æ­¥è¯·æ±‚
client.newCall(request).enqueue(new Callback() {
    @Override
    public void onResponse(Call call, Response response) {
        System.out.println("å¼‚æ­¥æˆåŠŸ: " + response.code());
    }
    
    @Override
    public void onFailure(Call call, IOException e) {
        System.out.println("å¼‚æ­¥å¤±è´¥: " + e.getMessage());
    }
});
```

### âœ… Day 3 æ£€æŸ¥ç‚¹
- [ ] ç†è§£OkHttpClientçš„ä½œç”¨
- [ ] èƒ½å¤Ÿé…ç½®Clientçš„å„é¡¹å‚æ•°
- [ ] ç†è§£execute()å’Œenqueue()çš„åŒºåˆ«
- [ ] èƒ½å¤Ÿç”»å‡ºå®Œæ•´çš„è¯·æ±‚æµç¨‹å›¾

### ğŸ“ Day 3 ä½œä¸š
1. ç”»å‡ºä»client.newCall().execute()åˆ°è¿”å›Responseçš„å®Œæ•´æµç¨‹å›¾
2. å¯¹æ¯”åŒæ­¥å’Œå¼‚æ­¥æ‰§è¡Œçš„åŒºåˆ«ï¼ˆçº¿ç¨‹ã€å›è°ƒç­‰ï¼‰
3. æ€è€ƒï¼šä¸ºä»€ä¹ˆæ¨èå…¨å±€å…±äº«ä¸€ä¸ªOkHttpClientï¼Ÿ

---

## ğŸ“… Day 4ï¼šæ‹¦æˆªå™¨å®ç°ï¼ˆä¸Šï¼‰

### ğŸ¯ å­¦ä¹ ç›®æ ‡
- ç†è§£BridgeInterceptorçš„ä½œç”¨
- æŒæ¡é‡è¯•å’Œé‡å®šå‘çš„å®ç°
- ç†è§£å„ä¸ªæ‹¦æˆªå™¨çš„èŒè´£

### ğŸ“š å­¦ä¹ å†…å®¹

#### ä¸Šåˆï¼ˆ1-1.5å°æ—¶ï¼‰ï¼šBridgeInterceptor

```java
// æ‰“å¼€æ¨¡æ¿ï¼š10_BridgeInterceptor_æ¨¡æ¿.java
// å­¦ä¹ é‡ç‚¹ï¼š
// - ä¸ºä»€ä¹ˆå«"æ¡¥æ¥"ï¼Ÿ
// - æ·»åŠ äº†å“ªäº›å¿…éœ€çš„HTTPå¤´ï¼Ÿ
// - GZIPå‹ç¼©çš„å¤„ç†
```

**å…³é”®èŒè´£**ï¼š
1. æ·»åŠ Content-Type
2. æ·»åŠ Content-Length
3. æ·»åŠ Host
4. æ·»åŠ Connection: Keep-Alive
5. æ·»åŠ User-Agent
6. å¤„ç†GZIPå‹ç¼©

**å®æˆ˜ä»»åŠ¡**ï¼š
```java
// å®ç°addRequiredHeaders()æ–¹æ³•
private Request addRequiredHeaders(Request request) {
    Request.Builder builder = request.newBuilder();
    
    // æ·»åŠ Content-Type
    if (request.body() != null && request.header("Content-Type") == null) {
        builder.header("Content-Type", request.body().contentType());
    }
    
    // æ·»åŠ Host
    if (request.header("Host") == null) {
        builder.header("Host", getHost(request.url()));
    }
    
    // æ·»åŠ Connection
    if (request.header("Connection") == null) {
        builder.header("Connection", "Keep-Alive");
    }
    
    // æ·»åŠ User-Agent
    if (request.header("User-Agent") == null) {
        builder.header("User-Agent", "MyOkHttp/1.0");
    }
    
    return builder.build();
}
```

#### ä¸‹åˆï¼ˆ1-1.5å°æ—¶ï¼‰ï¼šRetryAndFollowUpInterceptor

```java
// æ‰“å¼€æ¨¡æ¿ï¼š11_RetryAndFollowUpInterceptor_æ¨¡æ¿.java
// å­¦ä¹ é‡ç‚¹ï¼š
// - ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦é‡è¯•ï¼Ÿ
// - å¦‚ä½•å¤„ç†é‡å®šå‘ï¼Ÿ
// - æœ€å¤šé‡è¯•å‡ æ¬¡ï¼Ÿ
```

**é‡è¯•æ¡ä»¶**ï¼š
1. IOExceptionï¼ˆç½‘ç»œé”™è¯¯ï¼‰
2. 408 Request Timeout
3. 500/502/503ï¼ˆæœåŠ¡å™¨é”™è¯¯ï¼‰

**é‡å®šå‘å¤„ç†**ï¼š
1. 301/302/307/308
2. æå–Locationå¤´
3. åˆ›å»ºæ–°è¯·æ±‚
4. é™åˆ¶æœ€å¤š20æ¬¡ï¼ˆé˜²æ­¢æ­»å¾ªç¯ï¼‰

**å®æˆ˜ä»»åŠ¡**ï¼šå®ç°é‡è¯•é€»è¾‘
```java
private Response intercept(Chain chain) throws IOException {
    Request request = chain.request();
    int followUpCount = 0;
    
    while (true) {
        try {
            Response response = chain.proceed(request);
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡å®šå‘
            Request followUp = followUpRequest(response);
            if (followUp == null) {
                return response;  // ä¸éœ€è¦é‡å®šå‘
            }
            
            // æ£€æŸ¥é‡å®šå‘æ¬¡æ•°
            if (++followUpCount > 20) {
                throw new IOException("Too many redirects");
            }
            
            request = followUp;
        } catch (IOException e) {
            // é‡è¯•
            if (!isRecoverable(e)) {
                throw e;
            }
        }
    }
}
```

### âœ… Day 4 æ£€æŸ¥ç‚¹
- [ ] ç†è§£BridgeInterceptoræ·»åŠ äº†å“ªäº›HTTPå¤´
- [ ] ç†è§£é‡è¯•çš„æ¡ä»¶
- [ ] ç†è§£é‡å®šå‘çš„å¤„ç†æµç¨‹
- [ ] çŸ¥é“ä¸ºä»€ä¹ˆè¦é™åˆ¶é‡å®šå‘æ¬¡æ•°

### ğŸ“ Day 4 ä½œä¸š
1. åˆ—å‡ºBridgeInterceptoræ·»åŠ çš„æ‰€æœ‰HTTPå¤´åŠå…¶ä½œç”¨
2. å®ç°ä¸€ä¸ªæ”¯æŒé‡è¯•çš„æ‹¦æˆªå™¨ï¼ˆè§ç»ƒä¹ é¢˜ï¼‰
3. æ€è€ƒï¼šä¸ºä»€ä¹ˆ301å’Œ302çš„å¤„ç†ä¸åŒï¼Ÿ

---

## ğŸ“… Day 5ï¼šæ‹¦æˆªå™¨å®ç°ï¼ˆä¸‹ï¼‰â­â­â­â­â­

### ğŸ¯ å­¦ä¹ ç›®æ ‡
- **æ·±åˆ»ç†è§£HTTPåè®®**ï¼ˆæœ€é‡è¦ï¼ï¼‰
- æŒæ¡Socketç¼–ç¨‹
- ç†è§£è¿æ¥çš„è·å–å’Œä½¿ç”¨

### ğŸ“š å­¦ä¹ å†…å®¹

#### ä¸Šåˆï¼ˆ1å°æ—¶ï¼‰ï¼šConnectInterceptor

```java
// æ‰“å¼€æ¨¡æ¿ï¼š12_ConnectInterceptor_æ¨¡æ¿.java
// å­¦ä¹ é‡ç‚¹ï¼š
// - å¦‚ä½•ä»è¿æ¥æ± è·å–è¿æ¥ï¼Ÿ
// - å¦‚ä½•å»ºç«‹æ–°è¿æ¥ï¼Ÿ
// - è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸ
```

**æ ¸å¿ƒæµç¨‹**ï¼š
```java
1. è§£æURL â†’ hostå’Œport
2. ä»è¿æ¥æ± è·å– â†’ connectionPool.get(host, port)
3. å¦‚æœæ²¡æœ‰ â†’ åˆ›å»ºæ–°è¿æ¥
4. æ‰§è¡Œä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ï¼ˆä½¿ç”¨è¿™ä¸ªè¿æ¥ï¼‰
5. ä½¿ç”¨å®Œæ¯• â†’ æ”¾å›è¿æ¥æ± 
```

**å®æˆ˜ä»»åŠ¡**ï¼š
```java
// è·Ÿè¸ªè¿æ¥çš„è·å–å’Œå¤ç”¨
ConnectionPool pool = client.connectionPool();

// ç¬¬ä¸€æ¬¡è¯·æ±‚
System.out.println("è¯·æ±‚å‰è¿æ¥æ•°: " + pool.connectionCount());
Response r1 = client.newCall(request1).execute();
System.out.println("è¯·æ±‚åè¿æ¥æ•°: " + pool.connectionCount());

// ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆç›¸åŒhostï¼‰
Response r2 = client.newCall(request2).execute();
System.out.println("å¤ç”¨åè¿æ¥æ•°: " + pool.connectionCount());  // åº”è¯¥è¿˜æ˜¯1
```

#### ä¸‹åˆï¼ˆ2-3å°æ—¶ï¼‰ï¼šCallServerInterceptor â­â­â­â­â­

**è¿™æ˜¯ä»Šå¤©æœ€é‡è¦çš„å†…å®¹ï¼ä¹Ÿæ˜¯æ•´ä¸ªOkHttpæœ€æ ¸å¿ƒçš„æ‹¦æˆªå™¨ï¼**

```java
// æ‰“å¼€æ¨¡æ¿ï¼š13_CallServerInterceptor_æ¨¡æ¿.java
// ä»”ç»†é˜…è¯»æ¯ä¸€è¡Œæ³¨é‡Šï¼
```

**HTTPåè®®æ ¼å¼ï¼ˆå¿…é¡»ç‰¢è®°ï¼ï¼‰**ï¼š
```
è¯·æ±‚æ ¼å¼ï¼š
GET /path HTTP/1.1\r\n
Host: example.com\r\n
User-Agent: MyOkHttp\r\n
\r\n

å“åº”æ ¼å¼ï¼š
HTTP/1.1 200 OK\r\n
Content-Type: text/html\r\n
Content-Length: 123\r\n
\r\n
[å“åº”ä½“123å­—èŠ‚]
```

**å…³é”®ç‚¹**ï¼š
1. **\r\næ˜¯HTTPè¡Œåˆ†éš”ç¬¦**ï¼ˆCRLFï¼ŒCarriage Return + Line Feedï¼‰
2. **ç©ºè¡Œï¼ˆ\r\n\r\nï¼‰è¡¨ç¤ºå¤´éƒ¨ç»“æŸ**
3. **Content-LengthæŒ‡å®šå“åº”ä½“é•¿åº¦**

**å®æˆ˜ä»»åŠ¡1**ï¼šæ‰‹å†™HTTPè¯·æ±‚
```java
// ä¸ä½¿ç”¨OkHttpï¼Œç›´æ¥ç”¨Socketå‘é€HTTPè¯·æ±‚
Socket socket = new Socket("httpbin.org", 80);
OutputStream out = socket.getOutputStream();

// å†™å…¥HTTPè¯·æ±‚
String request = 
    "GET /get HTTP/1.1\r\n" +
    "Host: httpbin.org\r\n" +
    "User-Agent: Manual\r\n" +
    "Connection: close\r\n" +
    "\r\n";

out.write(request.getBytes());
out.flush();

// è¯»å–å“åº”
InputStream in = socket.getInputStream();
BufferedReader reader = new BufferedReader(new InputStreamReader(in));
String line;
while ((line = reader.readLine()) != null) {
    System.out.println(line);
}

socket.close();
```

**å®æˆ˜ä»»åŠ¡2**ï¼šå®ç°writeRequest()æ–¹æ³•
```java
private void writeRequest(OutputStream out, Request request) throws IOException {
    BufferedWriter writer = new BufferedWriter(new OutputStreamWriter(out, "UTF-8"));
    
    // 1. è¯·æ±‚è¡Œ
    String path = getPath(request.url());
    writer.write(request.method() + " " + path + " HTTP/1.1\r\n");
    
    // 2. è¯·æ±‚å¤´
    for (Map.Entry<String, String> header : request.headers().entrySet()) {
        writer.write(header.getKey() + ": " + header.getValue() + "\r\n");
    }
    
    // 3. ç©ºè¡Œ
    writer.write("\r\n");
    writer.flush();
    
    // 4. è¯·æ±‚ä½“
    if (request.body() != null) {
        request.body().writeTo(out);
    }
}
```

**å®æˆ˜ä»»åŠ¡3**ï¼šå®ç°readResponse()æ–¹æ³•ï¼ˆè§æ¨¡æ¿ï¼‰

### âœ… Day 5 æ£€æŸ¥ç‚¹
- [ ] ç†è§£HTTPåè®®æ ¼å¼
- [ ] çŸ¥é“\r\nçš„ä½œç”¨
- [ ] ç†è§£ç©ºè¡Œçš„ä½œç”¨
- [ ] èƒ½å¤Ÿæ‰‹å†™HTTPè¯·æ±‚
- [ ] ç†è§£Content-Lengthçš„å¤„ç†
- [ ] ç†è§£è¿æ¥çš„è·å–æµç¨‹

### ğŸ“ Day 5 ä½œä¸š
1. **é‡è¦**ï¼šç”¨Socketæ‰‹å†™ä¸€ä¸ªHTTPå®¢æˆ·ç«¯ï¼ˆä¸ä½¿ç”¨OkHttpï¼‰
2. å®ç°å®Œæ•´çš„writeRequest()å’ŒreadResponse()
3. é˜…è¯»ã€Šå®æˆ˜ç»ƒä¹ é¢˜.mdã€‹çš„ç»ƒä¹ 6
4. æŸ¥çœ‹Wiresharkæˆ–æŠ“åŒ…å·¥å…·ï¼Œè§‚å¯ŸçœŸå®çš„HTTPè¯·æ±‚æ ¼å¼

---

## ğŸ“… Day 6ï¼šè¿æ¥ç®¡ç†ï¼ˆæ€§èƒ½ä¼˜åŒ–å…³é”®ï¼‰

### ğŸ¯ å­¦ä¹ ç›®æ ‡
- ç†è§£è¿æ¥å¤ç”¨çš„åŸç†
- æŒæ¡è¿æ¥æ± çš„å®ç°
- ç†è§£æ¸…ç†ç­–ç•¥

### ğŸ“š å­¦ä¹ å†…å®¹

#### ä¸Šåˆï¼ˆ1-1.5å°æ—¶ï¼‰ï¼šRealConnection

```java
// æ‰“å¼€æ¨¡æ¿ï¼š14_RealConnection_æ¨¡æ¿.java
// å­¦ä¹ é‡ç‚¹ï¼š
// - Socketçš„ä½¿ç”¨
// - å¼•ç”¨è®¡æ•°çš„ä½œç”¨
// - è¿æ¥çŠ¶æ€ç®¡ç†
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
1. **Socket**ï¼šTCPè¿æ¥çš„ç¼–ç¨‹æ¥å£
2. **å¼•ç”¨è®¡æ•°**ï¼šè®°å½•æœ‰å¤šå°‘è¯·æ±‚åœ¨ä½¿ç”¨
3. **ç©ºé—²æ—¶é—´**ï¼šç”¨äºè¿æ¥æ± æ¸…ç†

**å®æˆ˜ä»»åŠ¡**ï¼š
```java
// æµ‹è¯•è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸ
RealConnection conn = new RealConnection("httpbin.org", 80);

// å»ºç«‹è¿æ¥
conn.connect(10000, 10000);
System.out.println("å·²è¿æ¥");

// ä½¿ç”¨è¿æ¥
conn.acquire();
System.out.println("ä½¿ç”¨ä¸­: " + conn.isInUse());

// å‘é€è¯·æ±‚...

// é‡Šæ”¾è¿æ¥
conn.release();
System.out.println("ç©ºé—²: " + !conn.isInUse());

// å…³é—­è¿æ¥
conn.close();
System.out.println("å·²å…³é—­: " + conn.isClosed());
```

#### ä¸‹åˆï¼ˆ1-1.5å°æ—¶ï¼‰ï¼šConnectionPool â­â­â­â­â­

```java
// æ‰“å¼€æ¨¡æ¿ï¼š15_ConnectionPool_æ¨¡æ¿.java
// å­¦ä¹ é‡ç‚¹ï¼š
// - è¿æ¥å¤ç”¨çš„åŸç†
// - æ¸…ç†ç­–ç•¥
// - å¤šçº¿ç¨‹åŒæ­¥
```

**æ ¸å¿ƒæœºåˆ¶**ï¼š
1. **å¤ç”¨æ¡ä»¶**ï¼šhostå’Œportç›¸åŒï¼Œè¿æ¥æœªå…³é—­ï¼Œæœªè¢«å ç”¨
2. **æ¸…ç†ç­–ç•¥**ï¼š
   - æœ€å¤š5ä¸ªç©ºé—²è¿æ¥
   - ç©ºé—²5åˆ†é’Ÿåæ¸…ç†
   - åå°çº¿ç¨‹å®šæœŸæ£€æŸ¥
3. **æ€§èƒ½æå‡**ï¼šè·³è¿‡TCPä¸‰æ¬¡æ¡æ‰‹ï¼ˆ50-100msï¼‰

**æ¸…ç†ç®—æ³•**ï¼š
```java
1. æ‰¾å‡ºæœ€é•¿ç©ºé—²çš„è¿æ¥
2. åˆ¤æ–­ï¼š
   - ç©ºé—²æ—¶é—´ >= 5åˆ†é’Ÿï¼Ÿæ¸…ç†ï¼Œè¿”å›0
   - ç©ºé—²è¿æ¥æ•° > 5ï¼Ÿæ¸…ç†æœ€è€çš„ï¼Œè¿”å›0
   - æœ‰ç©ºé—²è¿æ¥ï¼Ÿè¿”å›ç­‰å¾…æ—¶é—´
   - æœ‰ä½¿ç”¨ä¸­çš„è¿æ¥ï¼Ÿè¿”å›5åˆ†é’Ÿ
   - æ²¡æœ‰è¿æ¥ï¼Ÿè¿”å›-1ï¼ˆé€€å‡ºçº¿ç¨‹ï¼‰
```

**å®æˆ˜ä»»åŠ¡**ï¼š
```java
// æµ‹è¯•è¿æ¥å¤ç”¨
ConnectionPool pool = new ConnectionPool();

// ç¬¬ä¸€æ¬¡è¯·æ±‚
long start1 = System.currentTimeMillis();
RealConnection conn1 = pool.get("httpbin.org", 80);
if (conn1 == null) {
    conn1 = new RealConnection("httpbin.org", 80);
    conn1.connect(10000, 10000);  // è€—æ—¶~100ms
}
long time1 = System.currentTimeMillis() - start1;
System.out.println("ç¬¬ä¸€æ¬¡: " + time1 + "ms");

pool.put(conn1);

// ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆå¤ç”¨ï¼‰
long start2 = System.currentTimeMillis();
RealConnection conn2 = pool.get("httpbin.org", 80);  // ç«‹å³è¿”å›
long time2 = System.currentTimeMillis() - start2;
System.out.println("ç¬¬äºŒæ¬¡: " + time2 + "ms");  // ~0ms

System.out.println("å¤ç”¨: " + (conn1 == conn2));  // true
```

### âœ… Day 6 æ£€æŸ¥ç‚¹
- [ ] ç†è§£å¼•ç”¨è®¡æ•°çš„ä½œç”¨
- [ ] ç†è§£è¿æ¥æ± çš„å¤ç”¨æ¡ä»¶
- [ ] ç†è§£æ¸…ç†ç­–ç•¥
- [ ] èƒ½å¤Ÿè®¡ç®—æ€§èƒ½æå‡

### ğŸ“ Day 6 ä½œä¸š
1. å®ç°å®Œæ•´çš„RealConnectionå’ŒConnectionPool
2. æµ‹è¯•è¿æ¥å¤ç”¨ï¼Œå¯¹æ¯”æ€§èƒ½å·®å¼‚
3. é˜…è¯»ã€Šå®æˆ˜ç»ƒä¹ é¢˜.mdã€‹çš„ç»ƒä¹ 4å’Œç»ƒä¹ 8
4. æ€è€ƒï¼šä¸ºä»€ä¹ˆé»˜è®¤æ˜¯5ä¸ªè¿æ¥å’Œ5åˆ†é’Ÿï¼Ÿ

---

## ğŸ“… Day 7ï¼šè°ƒåº¦ä¸æ€»ç»“

### ğŸ¯ å­¦ä¹ ç›®æ ‡
- ç†è§£Dispatcherçš„ä½œç”¨
- æŒæ¡å¹¶å‘æ§åˆ¶
- å®Œæˆç»¼åˆç»ƒä¹ 

### ğŸ“š å­¦ä¹ å†…å®¹

#### ä¸Šåˆï¼ˆ1-1.5å°æ—¶ï¼‰ï¼šDispatcher

```java
// æ‰“å¼€æ¨¡æ¿ï¼š16_Dispatcher_æ¨¡æ¿.java
// å­¦ä¹ é‡ç‚¹ï¼š
// - ä¸‰ä¸ªé˜Ÿåˆ—çš„ä½œç”¨
// - å¹¶å‘æ§åˆ¶
// - promoteAndExecute()
```

**ä¸‰ä¸ªé˜Ÿåˆ—**ï¼š
1. **runningAsyncCalls**ï¼šæ­£åœ¨æ‰§è¡Œï¼ˆæœ€å¤š64ä¸ªï¼‰
2. **readyAsyncCalls**ï¼šç­‰å¾…æ‰§è¡Œ
3. **runningSyncCalls**ï¼šåŒæ­¥è¯·æ±‚ï¼ˆæ— é™åˆ¶ï¼‰

**å·¥ä½œæµç¨‹**ï¼š
```
enqueue(call)
  â†“
æ£€æŸ¥: runningAsyncCalls.size() < 64?
  â†“ æ˜¯                      â†“ å¦
ç›´æ¥æ‰§è¡Œ                  åŠ å…¥ç­‰å¾…é˜Ÿåˆ—
  â†“
finished(call)
  â†“
ä»runningAsyncCallsç§»é™¤
  â†“
promoteAndExecute()
  â†“
ä»readyAsyncCallså–ä¸‹ä¸€ä¸ª
  â†“
åŠ å…¥runningAsyncCallså¹¶æ‰§è¡Œ
```

**å®æˆ˜ä»»åŠ¡**ï¼š
```java
// æµ‹è¯•å¹¶å‘æ§åˆ¶
Dispatcher dispatcher = new Dispatcher();
dispatcher.setMaxRequests(2);  // æœ€å¤š2ä¸ªå¹¶å‘

// æ·»åŠ 5ä¸ªè¯·æ±‚
for (int i = 0; i < 5; i++) {
    client.newCall(request).enqueue(callback);
}

// è¾“å‡ºï¼š
// è¿è¡Œä¸­: 2
// ç­‰å¾…ä¸­: 3

// å½“ä¸€ä¸ªå®Œæˆåï¼š
// è¿è¡Œä¸­: 2ï¼ˆè‡ªåŠ¨ä»ç­‰å¾…é˜Ÿåˆ—å–ä¸€ä¸ªï¼‰
// ç­‰å¾…ä¸­: 2
```

#### ä¸‹åˆï¼ˆ1-1.5å°æ—¶ï¼‰ï¼šç»¼åˆç»ƒä¹ ä¸æ€»ç»“

**ç»ƒä¹ 1**ï¼šç”»å‡ºå®Œæ•´çš„è¯·æ±‚æµç¨‹å›¾
```
client.newCall(request).execute()
  â†“
RealCall.execute()
  â†“
dispatcher.executed(this)
  â†“
getResponseWithInterceptorChain()
  â†“
RealInterceptorChain.proceed()
  â†“
RetryAndFollowUpInterceptor
  â†“
BridgeInterceptor
  â†“
ConnectInterceptor
  â†“
CallServerInterceptor
  â†“
è¿”å›Response
  â†“
dispatcher.finished(this)
  â†“
è¿”å›ç»™è°ƒç”¨è€…
```

**ç»ƒä¹ 2**ï¼šå®ç°ä¸€ä¸ªç®€å•çš„OkHttp
```java
// è¦æ±‚ï¼š
// 1. æ”¯æŒGETå’ŒPOSTè¯·æ±‚
// 2. æ”¯æŒæ·»åŠ è‡ªå®šä¹‰æ‹¦æˆªå™¨
// 3. æ”¯æŒè¿æ¥å¤ç”¨
// 4. æ”¯æŒå¼‚æ­¥è¯·æ±‚

// æµ‹è¯•ï¼š
OkHttpClient client = new OkHttpClient.Builder()
    .addInterceptor(new LoggingInterceptor())
    .build();

Request request = new Request.Builder()
    .url("http://httpbin.org/get")
    .build();

// åŒæ­¥
Response response = client.newCall(request).execute();
System.out.println(response.body().string());

// å¼‚æ­¥
client.newCall(request).enqueue(new Callback() {
    @Override
    public void onResponse(Call call, Response response) {
        System.out.println("æˆåŠŸ");
    }
    
    @Override
    public void onFailure(Call call, IOException e) {
        System.out.println("å¤±è´¥");
    }
});
```

**ç»ƒä¹ 3**ï¼šå®Œæˆæ‰€æœ‰å®æˆ˜ç»ƒä¹ é¢˜ï¼ˆè§å®æˆ˜ç»ƒä¹ é¢˜.mdï¼‰

### âœ… Day 7 æ£€æŸ¥ç‚¹
- [ ] ç†è§£Dispatcherçš„ä¸‰ä¸ªé˜Ÿåˆ—
- [ ] ç†è§£å¹¶å‘æ§åˆ¶çš„å®ç°
- [ ] èƒ½å¤Ÿç”»å‡ºå®Œæ•´çš„è¯·æ±‚æµç¨‹
- [ ] å®Œæˆç»¼åˆç»ƒä¹ 

### ğŸ“ Day 7 ä½œä¸š
1. å¤ä¹ Day 1-6çš„æ‰€æœ‰æ ¸å¿ƒçŸ¥è¯†ç‚¹
2. å®Œæˆã€Šå®æˆ˜ç»ƒä¹ é¢˜.mdã€‹çš„æ‰€æœ‰é¢˜ç›®
3. å¯¹æ¯”ä½ çš„å®ç°å’ŒçœŸå®OkHttpæºç 
4. æ€»ç»“å­¦ä¹ ç¬”è®°

---

## ğŸ¯ å­¦ä¹ æˆæœéªŒæ”¶

å®Œæˆ7å¤©å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

### ç†è®ºçŸ¥è¯†
- [ ] æ·±åˆ»ç†è§£è´£ä»»é“¾æ¨¡å¼
- [ ] ç†è§£HTTPåè®®æ ¼å¼
- [ ] ç†è§£è¿æ¥å¤ç”¨çš„åŸç†
- [ ] ç†è§£Builderæ¨¡å¼çš„ä¼˜åŠ¿
- [ ] ç†è§£å¤šçº¿ç¨‹åŒæ­¥

### å®æˆ˜èƒ½åŠ›
- [ ] ç‹¬ç«‹å®ç°ç®€åŒ–ç‰ˆOkHttp
- [ ] å®ç°è‡ªå®šä¹‰æ‹¦æˆªå™¨
- [ ] æ‰‹å†™HTTPå®¢æˆ·ç«¯ï¼ˆSocketï¼‰
- [ ] å®ç°è¿æ¥æ± 
- [ ] å®ç°å¹¶å‘æ§åˆ¶

### é¢è¯•å‡†å¤‡
- [ ] èƒ½å¤Ÿè®²è§£OkHttpçš„å·¥ä½œåŸç†
- [ ] èƒ½å¤Ÿè®²è§£æ‹¦æˆªå™¨çš„é€’å½’è°ƒç”¨
- [ ] èƒ½å¤Ÿè®²è§£è¿æ¥å¤ç”¨çš„å¥½å¤„
- [ ] èƒ½å¤Ÿè®²è§£HTTPåè®®
- [ ] èƒ½å¤Ÿå›ç­”å¸¸è§é¢è¯•é¢˜

---

## ğŸ“š æ¨èèµ„æº

### å®˜æ–¹èµ„æº
- OkHttpå®˜æ–¹æ–‡æ¡£ï¼šhttps://square.github.io/okhttp/
- OkHttpæºç ï¼šhttps://github.com/square/okhttp

### å­¦ä¹ å·¥å…·
- Wiresharkï¼šæŠ“åŒ…æŸ¥çœ‹HTTPè¯·æ±‚
- Postmanï¼šæµ‹è¯•HTTPæ¥å£
- IntelliJ IDEAï¼šè°ƒè¯•æºç 

### ç›¸å…³çŸ¥è¯†
- HTTP/1.1è§„èŒƒï¼šRFC 2616
- Java Socketç¼–ç¨‹
- è®¾è®¡æ¨¡å¼ï¼ˆè´£ä»»é“¾ã€Builderã€å•ä¾‹ï¼‰

---

## ğŸ’¡ å­¦ä¹ å»ºè®®

### 1. å¾ªåºæ¸è¿›
ä¸è¦è·³è¿‡ä»»ä½•ä¸€å¤©ï¼Œæ¯å¤©çš„å†…å®¹éƒ½æœ‰è”ç³»ã€‚

### 2. åŠ¨æ‰‹å®è·µ
çœ‹æ‡‚â‰ ä¼šç”¨ï¼Œä¸€å®šè¦è‡ªå·±å†™ä»£ç ã€‚

### 3. ç”»å›¾ç†è§£
å¯¹äºå¤æ‚çš„æµç¨‹ï¼ˆå¦‚æ‹¦æˆªå™¨é“¾ï¼‰ï¼Œç”»æµç¨‹å›¾å¸®åŠ©ç†è§£ã€‚

### 4. å¯¹æ¯”å­¦ä¹ 
å¯¹æ¯”ä½ çš„å®ç°å’ŒçœŸå®OkHttpæºç ï¼Œçœ‹çœ‹å·®å¼‚ã€‚

### 5. æ€»ç»“ç¬”è®°
æ¯å¤©å­¦ä¹ åï¼Œå†™ä¸‹ä½ çš„ç†è§£å’Œå¿ƒå¾—ã€‚

---

## ğŸ‰ å‡†å¤‡å¥½äº†å—ï¼Ÿ

ä»**Day 1**å¼€å§‹ï¼Œå¼€å¯ä½ çš„OkHttpæºç å­¦ä¹ ä¹‹æ—…å§ï¼

è®°ä½ï¼š**ç†è§£æ¯”é€Ÿåº¦æ›´é‡è¦ï¼Œä¸è¦æ€¥äºæ±‚æˆï¼**

ç¥ä½ å­¦ä¹ æ„‰å¿«ï¼ğŸ’ª

