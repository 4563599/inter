# å‰©ä½™6ä¸ªæ¨¡æ¿å¿«é€ŸæŒ‡å—

æˆ‘å·²ç»ä¸ºä½ åˆ›å»ºäº†**10ä¸ªè¶…è¯¦ç»†çš„æ¨¡æ¿**ï¼ˆæ¯ä¸ª200-500è¡Œæ³¨é‡Šï¼‰ã€‚

å¯¹äºå‰©ä½™çš„6ä¸ªç±»ï¼Œä½ å¯ä»¥ï¼š

## æ–¹æ¡ˆ1ï¼šå‚è€ƒå·²æœ‰æ¨¡æ¿+æºç ï¼ˆæ¨èï¼‰

å‰©ä½™çš„6ä¸ªç±»å¯ä»¥**å‚è€ƒå·²åˆ›å»ºçš„æ¨¡æ¿é£æ ¼** + **src/main/java/com/myokhttp/** ä¸­çš„å®Œæ•´å®ç°ã€‚

### 11. RetryAndFollowUpInterceptorï¼ˆé‡è¯•å’Œé‡å®šå‘æ‹¦æˆªå™¨ï¼‰

**å‚è€ƒï¼š** `templates/10_BridgeInterceptor_æ¨¡æ¿.java`ï¼ˆæ‹¦æˆªå™¨å†™æ³•ï¼‰

**æ ¸å¿ƒé€»è¾‘ï¼š**
```java
// ç”¨ while(true) å¾ªç¯å¤„ç†é‡è¯•å’Œé‡å®šå‘
while (true) {
    try {
        Response response = chain.proceed(request);
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡å®šå‘
        Request followUp = followUpRequest(response);
        if (followUp == null) {
            return response;  // ä¸éœ€è¦é‡å®šå‘
        }
        
        // ç»§ç»­å¤„ç†é‡å®šå‘
        request = followUp;
    } catch (IOException e) {
        // åˆ¤æ–­æ˜¯å¦éœ€è¦é‡è¯•
        if (!isRecoverable(e)) {
            throw e;
        }
        // ç»§ç»­é‡è¯•
    }
}
```

**å…³é”®æ–¹æ³•ï¼š**
- `followUpRequest()` - æ ¹æ®çŠ¶æ€ç åˆ¤æ–­æ˜¯å¦é‡å®šå‘
- `isRecoverable()` - åˆ¤æ–­å¼‚å¸¸æ˜¯å¦å¯ä»¥é‡è¯•

**å‚è€ƒæ–‡ä»¶ï¼š** `src/main/java/com/myokhttp/RetryAndFollowUpInterceptor.java`

---

### 12. ConnectInterceptorï¼ˆè¿æ¥æ‹¦æˆªå™¨ï¼‰

**å‚è€ƒï¼š** `templates/10_BridgeInterceptor_æ¨¡æ¿.java`

**æ ¸å¿ƒé€»è¾‘ï¼š**
```java
// 1. ä»è¿æ¥æ± è·å–è¿æ¥
RealConnection connection = connectionPool.get(host, port);

// 2. å¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºæ–°è¿æ¥
if (connection == null) {
    connection = new RealConnection(host, port);
    connection.connect(connectTimeout, readTimeout);
    connection.acquire();
}

// 3. æ‰§è¡Œè¯·æ±‚
Response response = chain.proceed(request);

// 4. æ”¾å›è¿æ¥æ± 
connectionPool.put(connection);
```

**å‚è€ƒæ–‡ä»¶ï¼š** `src/main/java/com/myokhttp/ConnectInterceptor.java`

---

### 13. CallServerInterceptorï¼ˆæœåŠ¡å™¨è°ƒç”¨æ‹¦æˆªå™¨ï¼‰â­â­â­â­â­

**è¿™æ˜¯æœ€é‡è¦çš„æ‹¦æˆªå™¨ï¼**

**æ ¸å¿ƒé€»è¾‘ï¼š**
```java
// 1. å†™å…¥HTTPè¯·æ±‚
writeRequest(connection, request);

// 2. è¯»å–HTTPå“åº”
Response response = readResponse(connection, request);

return response;
```

**HTTPè¯·æ±‚æ ¼å¼ï¼š**
```
GET /path HTTP/1.1\r\n
Host: example.com\r\n
\r\n
[è¯·æ±‚ä½“]
```

**HTTPå“åº”æ ¼å¼ï¼š**
```
HTTP/1.1 200 OK\r\n
Content-Length: 123\r\n
\r\n
[å“åº”ä½“]
```

**å…³é”®ç‚¹ï¼š**
- \r\n æ˜¯è¡Œåˆ†éš”ç¬¦
- ç©ºè¡Œè¡¨ç¤ºå¤´éƒ¨ç»“æŸ
- æ ¹æ® Content-Length è¯»å–å“åº”ä½“

**å‚è€ƒæ–‡ä»¶ï¼š** `src/main/java/com/myokhttp/CallServerInterceptor.java`

---

### 14. RealConnectionï¼ˆçœŸå®è¿æ¥ï¼‰

**æ ¸å¿ƒå­—æ®µï¼š**
```java
private final String host;
private final int port;
private Socket socket;
private int referenceCount = 0;  // å¼•ç”¨è®¡æ•°
private long idleAtNanos;        // ç©ºé—²å¼€å§‹æ—¶é—´
```

**å…³é”®æ–¹æ³•ï¼š**
- `connect()` - å»ºç«‹TCPè¿æ¥
- `acquire()` - å¼•ç”¨è®¡æ•°+1
- `release()` - å¼•ç”¨è®¡æ•°-1
- `isInUse()` - æ˜¯å¦æ­£åœ¨ä½¿ç”¨

**å‚è€ƒæ–‡ä»¶ï¼š** `src/main/java/com/myokhttp/RealConnection.java`

---

### 15. ConnectionPoolï¼ˆè¿æ¥æ± ï¼‰â­â­â­â­

**æ ¸å¿ƒé€»è¾‘ï¼š**
```java
// è·å–è¿æ¥
public RealConnection get(String host, int port) {
    for (RealConnection conn : connections) {
        if (conn.getHost().equals(host) 
            && conn.getPort() == port 
            && !conn.isClosed()) {
            conn.acquire();
            return conn;
        }
    }
    return null;
}

// æ”¾å›è¿æ¥
public void put(RealConnection connection) {
    connection.release();
    connections.add(connection);
}

// æ¸…ç†ç©ºé—²è¿æ¥ï¼ˆåå°çº¿ç¨‹ï¼‰
private long cleanup(long now) {
    // æ‰¾å‡ºæœ€é•¿ç©ºé—²çš„è¿æ¥
    // å¦‚æœç©ºé—²æ—¶é—´è¶…è¿‡é™åˆ¶ï¼Œå…³é—­å®ƒ
}
```

**å‚è€ƒæ–‡ä»¶ï¼š** `src/main/java/com/myokhttp/ConnectionPool.java`

---

### 16. Dispatcherï¼ˆè°ƒåº¦å™¨ï¼‰

**æ ¸å¿ƒå­—æ®µï¼š**
```java
private int maxRequests = 64;
private ExecutorService executorService;
private Deque<AsyncCall> runningAsyncCalls;  // æ­£åœ¨è¿è¡Œ
private Deque<AsyncCall> readyAsyncCalls;    // ç­‰å¾…é˜Ÿåˆ—
```

**æ ¸å¿ƒæ–¹æ³•ï¼š**
```java
// æ·»åŠ å¼‚æ­¥è¯·æ±‚
public void enqueue(AsyncCall call) {
    if (runningAsyncCalls.size() < maxRequests) {
        runningAsyncCalls.add(call);
        executorService().execute(call);
    } else {
        readyAsyncCalls.add(call);  // åŠ å…¥ç­‰å¾…é˜Ÿåˆ—
    }
}

// è¯·æ±‚å®Œæˆ
public void finished(AsyncCall call) {
    runningAsyncCalls.remove(call);
    promoteAndExecute();  // ä»ç­‰å¾…é˜Ÿåˆ—å–ä¸‹ä¸€ä¸ª
}
```

**å‚è€ƒæ–‡ä»¶ï¼š** `src/main/java/com/myokhttp/Dispatcher.java`

---

## æ–¹æ¡ˆ2ï¼šæˆ‘ç»§ç»­åˆ›å»ºè¯¦ç»†æ¨¡æ¿

å¦‚æœä½ éœ€è¦æŸä¸ªç‰¹å®šç±»çš„è¯¦ç»†æ¨¡æ¿ï¼ˆ200-500è¡Œæ³¨é‡Šï¼‰ï¼Œå‘Šè¯‰æˆ‘ï¼Œæˆ‘ç«‹å³ä¸ºä½ åˆ›å»ºï¼

ä¾‹å¦‚ï¼š
- "è¯·åˆ›å»º CallServerInterceptor çš„è¯¦ç»†æ¨¡æ¿"
- "è¯·åˆ›å»º ConnectionPool çš„è¯¦ç»†æ¨¡æ¿"

---

## æ–¹æ¡ˆ3ï¼šç›´æ¥é˜…è¯»æºç 

`src/main/java/com/myokhttp/` ä¸­çš„ä»£ç å·²ç»æœ‰å¾ˆè¯¦ç»†çš„æ³¨é‡Šï¼Œä½ å¯ä»¥ï¼š

1. æ‰“å¼€æºç æ–‡ä»¶
2. é˜…è¯»æ³¨é‡Šå’Œä»£ç 
3. ç†è§£åè‡ªå·±é‡å†™
4. å¯¹æ¯”å·®å¼‚

---

## ğŸ“ å»ºè®®çš„å­¦ä¹ æ–¹å¼

### å¯¹äºå‰©ä½™6ä¸ªç±»ï¼š

1. **å…ˆçœ‹ã€Šç¼–å†™é¡ºåºæŒ‡å—.mdã€‹** ä¸­å¯¹è¿™ä¸ªç±»çš„è¯´æ˜
2. **å†çœ‹ä¸Šé¢çš„å¿«é€ŸæŒ‡å—** äº†è§£æ ¸å¿ƒé€»è¾‘
3. **ç„¶åæ‰“å¼€æºç ** `src/main/java/com/myokhttp/XXX.java`
4. **å¯¹ç…§ç€å†™** ç†è§£ä¸€æ®µï¼Œå†™ä¸€æ®µ
5. **æµ‹è¯•éªŒè¯** è¿è¡Œç¤ºä¾‹ä»£ç 

---

## ğŸ¯ ä½ ç°åœ¨æ‹¥æœ‰

### å·²åˆ›å»ºçš„è¯¦ç»†æ¨¡æ¿ï¼ˆ10ä¸ªï¼‰
- æ¯ä¸ªéƒ½æœ‰200-500è¡Œæ³¨é‡Š
- è¯¦ç»†è§£é‡Š"ä¸ºä»€ä¹ˆ"
- å®Œæ•´çš„TODOæç¤º
- æµ‹è¯•æ–¹æ³•å’Œå¸¸è§é”™è¯¯

### å®Œæ•´çš„å‚è€ƒå®ç°ï¼ˆ16ä¸ªï¼‰
- æ‰€æœ‰æºç éƒ½åœ¨ `src/main/java/com/myokhttp/`
- å¯ä»¥ç›´æ¥è¿è¡Œ
- æœ‰è¯¦ç»†æ³¨é‡Š

### å®Œæ•´çš„å­¦ä¹ æ–‡æ¡£ï¼ˆ8ä¸ªï¼‰
- ç¼–å†™é¡ºåºæŒ‡å—
- åˆ†æ­¥å®ç°æ•™ç¨‹
- æ ¸å¿ƒæµç¨‹å›¾
- é¢è¯•é¢˜è§£æ
- ç­‰ç­‰...

---

## ğŸ’¡ æ¨èåšæ³•

å¯¹äº**æœ€é‡è¦çš„3ä¸ªç±»**ï¼Œå»ºè®®è¦æˆ‘åˆ›å»ºè¯¦ç»†æ¨¡æ¿ï¼š

1. **CallServerInterceptor** â­â­â­â­â­
   - æœ€æ ¸å¿ƒçš„æ‹¦æˆªå™¨
   - å®ç°HTTPåè®®
   - æœ€å¤æ‚

2. **ConnectionPool** â­â­â­â­
   - è¿æ¥æ± çš„å®ç°
   - è¿æ¥å¤ç”¨çš„å…³é”®
   - åŒ…å«åå°æ¸…ç†çº¿ç¨‹

3. **RetryAndFollowUpInterceptor** â­â­â­â­
   - é‡è¯•å’Œé‡å®šå‘é€»è¾‘
   - åŒ…å«å¾ªç¯å¤„ç†

å¯¹äºå…¶ä»–3ä¸ªç±»ï¼ˆConnectInterceptor, RealConnection, Dispatcherï¼‰ï¼Œå‚è€ƒå·²æœ‰æ¨¡æ¿+æºç å°±å¤Ÿäº†ã€‚

---

**å‘Šè¯‰æˆ‘ä½ éœ€è¦å“ªäº›è¯¦ç»†æ¨¡æ¿ï¼Œæˆ‘ç«‹å³åˆ›å»ºï¼** ğŸš€

æˆ–è€…ï¼Œå¦‚æœä½ æƒ³è‡ªå·±å­¦ä¹ ï¼Œç°æœ‰çš„èµ„æºå·²ç»éå¸¸å……è¶³äº†ï¼š
- 10ä¸ªè¯¦ç»†æ¨¡æ¿
- 16ä¸ªå®Œæ•´å®ç°
- 8ä¸ªå­¦ä¹ æ–‡æ¡£

