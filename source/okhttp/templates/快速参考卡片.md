# ğŸ¯ OkHttpæ ¸å¿ƒçŸ¥è¯†å¿«é€Ÿå‚è€ƒå¡ç‰‡

## ğŸ“Œ 16ä¸ªç±»çš„æ ¸å¿ƒä½œç”¨ï¼ˆä¸€å¥è¯æ€»ç»“ï¼‰

| åºå· | ç±»å | æ ¸å¿ƒä½œç”¨ | å…³é”®ç‚¹ |
|------|------|---------|--------|
| 01 | RequestBody | å°è£…è¯·æ±‚ä½“æ•°æ® | æŠ½è±¡ç±»ï¼Œæä¾›contentTypeå’ŒwriteTo |
| 02 | ResponseBody | å°è£…å“åº”ä½“æ•°æ® | æä¾›string()å’Œbytes()æ–¹æ³•è¯»å– |
| 03 | Request | ä¸å¯å˜çš„HTTPè¯·æ±‚ | Builderæ¨¡å¼ï¼Œurl/method/headers/body |
| 04 | Response | ä¸å¯å˜çš„HTTPå“åº” | Builderæ¨¡å¼ï¼Œcode/message/headers/body |
| 05 | Call | HTTPè°ƒç”¨æ¥å£ | execute()åŒæ­¥ï¼Œenqueue()å¼‚æ­¥ |
| 06 | Interceptor | æ‹¦æˆªå™¨æ¥å£ | intercept(Chain)æ–¹æ³•ï¼Œè´£ä»»é“¾æ¨¡å¼ |
| 07 | RealInterceptorChain | æ‹¦æˆªå™¨é“¾å®ç° | **æœ€æ ¸å¿ƒï¼é€’å½’è°ƒç”¨æ‹¦æˆªå™¨** |
| 08 | OkHttpClient | HTTPå®¢æˆ·ç«¯ | ç»Ÿä¸€å…¥å£ï¼Œç®¡ç†é…ç½®å’Œæ‹¦æˆªå™¨ |
| 09 | RealCall | Callçš„å®ç° | åŒæ­¥execute()ï¼Œå¼‚æ­¥enqueue() |
| 10 | BridgeInterceptor | æ¡¥æ¥æ‹¦æˆªå™¨ | æ·»åŠ å¿…éœ€çš„HTTPå¤´ |
| 11 | RetryAndFollowUpInterceptor | é‡è¯•é‡å®šå‘æ‹¦æˆªå™¨ | å¤„ç†é‡è¯•å’Œ3xxé‡å®šå‘ |
| 12 | ConnectInterceptor | è¿æ¥æ‹¦æˆªå™¨ | ä»è¿æ¥æ± è·å–æˆ–åˆ›å»ºè¿æ¥ |
| 13 | CallServerInterceptor | æœåŠ¡å™¨è°ƒç”¨æ‹¦æˆªå™¨ | **æœ€æ ¸å¿ƒï¼æ‰§è¡ŒçœŸå®çš„HTTPé€šä¿¡** |
| 14 | RealConnection | çœŸå®è¿æ¥ | å°è£…Socketï¼Œç®¡ç†è¿æ¥çŠ¶æ€ |
| 15 | ConnectionPool | è¿æ¥æ±  | **æ€§èƒ½å…³é”®ï¼å¤ç”¨TCPè¿æ¥** |
| 16 | Dispatcher | è°ƒåº¦å™¨ | ç®¡ç†å¼‚æ­¥è¯·æ±‚çš„å¹¶å‘æ‰§è¡Œ |

---

## ğŸ”¥ ä¸‰å¤§æ ¸å¿ƒç»„ä»¶

### 1ï¸âƒ£ RealInterceptorChainï¼ˆæ‹¦æˆªå™¨é“¾ï¼‰â­â­â­â­â­
```java
// æ ¸å¿ƒä»£ç ï¼ˆç®€åŒ–ç‰ˆï¼‰
public Response proceed(Request request) {
    // åˆ›å»ºä¸‹ä¸€ä¸ªChain
    RealInterceptorChain next = new RealInterceptorChain(
        interceptors, index + 1, request, this
    );
    
    // è·å–å½“å‰æ‹¦æˆªå™¨
    Interceptor interceptor = interceptors.get(index);
    
    // è°ƒç”¨å½“å‰æ‹¦æˆªå™¨ï¼Œä¼ å…¥ä¸‹ä¸€ä¸ªChain
    Response response = interceptor.intercept(next);
    
    return response;
}
```
**å…³é”®ç‚¹**ï¼š
- é€’å½’è°ƒç”¨ï¼šæ¯ä¸ªæ‹¦æˆªå™¨è°ƒç”¨chain.proceed()ï¼Œè§¦å‘ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨
- indexæ§åˆ¶ä½ç½®ï¼šindexä»0é€’å¢åˆ°æ‹¦æˆªå™¨æ•°é‡
- è´£ä»»é“¾æ¨¡å¼ï¼šæ¯ä¸ªæ‹¦æˆªå™¨å¤„ç†ä¸€éƒ¨åˆ†é€»è¾‘

### 2ï¸âƒ£ CallServerInterceptorï¼ˆHTTPåè®®å®ç°ï¼‰â­â­â­â­â­
```java
// HTTPè¯·æ±‚æ ¼å¼
GET /path HTTP/1.1\r\n
Host: example.com\r\n
User-Agent: MyOkHttp\r\n
\r\n

// HTTPå“åº”æ ¼å¼
HTTP/1.1 200 OK\r\n
Content-Type: text/html\r\n
Content-Length: 123\r\n
\r\n
[å“åº”ä½“]
```
**å…³é”®ç‚¹**ï¼š
- \r\næ˜¯è¡Œåˆ†éš”ç¬¦ï¼ˆCRLFï¼‰
- ç©ºè¡Œï¼ˆ\r\n\r\nï¼‰åˆ†éš”å¤´éƒ¨å’Œbody
- æ ¹æ®Content-Lengthè¯»å–å“åº”ä½“

### 3ï¸âƒ£ ConnectionPoolï¼ˆè¿æ¥å¤ç”¨ï¼‰â­â­â­â­â­
```java
// è·å–è¿æ¥
RealConnection conn = connectionPool.get(host, port);
if (conn == null) {
    // æ²¡æœ‰å¯å¤ç”¨çš„ï¼Œåˆ›å»ºæ–°è¿æ¥ï¼ˆè€—æ—¶100msï¼‰
    conn = new RealConnection(host, port);
    conn.connect();
} else {
    // å¤ç”¨è¿æ¥ï¼ˆ0msï¼‰
}
```
**å…³é”®ç‚¹**ï¼š
- è·³è¿‡TCPä¸‰æ¬¡æ¡æ‰‹ï¼ŒèŠ‚çœ50-100ms
- è·³è¿‡TLSæ¡æ‰‹ï¼ˆHTTPSï¼‰ï¼ŒèŠ‚çœ100-200ms
- æ€§èƒ½æå‡50-70%

---

## ğŸ¯ æ‹¦æˆªå™¨æ‰§è¡Œé¡ºåºï¼ˆå¿…é¡»è®°ä½ï¼ï¼‰

```
è¯·æ±‚ â†’
    1. RetryAndFollowUpInterceptor  ã€é‡è¯•ã€é‡å®šå‘ã€‘
    â†“
    2. BridgeInterceptor            ã€æ·»åŠ HTTPå¤´ã€‘
    â†“
    3. ConnectInterceptor           ã€è·å–è¿æ¥ã€‘
    â†“
    4. CallServerInterceptor        ã€æ‰§è¡ŒHTTPé€šä¿¡ã€‘
    â†“
â† å“åº”
```

**æ¯ä¸ªæ‹¦æˆªå™¨çš„ä½œç”¨**ï¼š
1. **RetryAndFollowUp**ï¼šå¤±è´¥äº†é‡è¯•ï¼Œæ”¶åˆ°3xxé‡å®šå‘
2. **Bridge**ï¼šæ·»åŠ Content-Typeã€User-Agentç­‰å¿…éœ€å¤´
3. **Connect**ï¼šä»è¿æ¥æ± è·å–è¿æ¥ï¼Œæ²¡æœ‰å°±åˆ›å»º
4. **CallServer**ï¼šé€šè¿‡Socketå‘é€è¯·æ±‚ï¼Œè¯»å–å“åº”

---

## ğŸ§© è®¾è®¡æ¨¡å¼é€ŸæŸ¥

| æ¨¡å¼ | ä½¿ç”¨ä½ç½® | ä½œç”¨ |
|------|---------|------|
| **Builderæ¨¡å¼** | Requestã€Response | ä¼˜é›…åœ°åˆ›å»ºä¸å¯å˜å¯¹è±¡ |
| **è´£ä»»é“¾æ¨¡å¼** | Interceptoré“¾ | å°†è¯·æ±‚å¤„ç†åˆ†è§£æˆå¤šä¸ªç¯èŠ‚ |
| **å·¥å‚æ¨¡å¼** | RequestBody.create() | åˆ›å»ºä¸åŒç±»å‹çš„RequestBody |
| **å•ä¾‹æ¨¡å¼** | OkHttpClientï¼ˆæ¨èï¼‰ | å…¨å±€å…±äº«é…ç½®å’Œè¿æ¥æ±  |
| **å¯¹è±¡æ± æ¨¡å¼** | ConnectionPool | å¤ç”¨æ˜‚è´µçš„TCPè¿æ¥ |

---

## âš¡ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹

### 1. å¤ç”¨OkHttpClient
```java
// âŒ é”™è¯¯ï¼šæ¯æ¬¡åˆ›å»ºæ–°Client
OkHttpClient client = new OkHttpClient();
client.newCall(request).execute();

// âœ… æ­£ç¡®ï¼šå…¨å±€å•ä¾‹
public class HttpManager {
    private static final OkHttpClient client = new OkHttpClient();
    public static OkHttpClient getClient() { return client; }
}
```
**åŸå› **ï¼šæ¯ä¸ªClientéƒ½æœ‰ç‹¬ç«‹çš„è¿æ¥æ± å’Œçº¿ç¨‹æ± 

### 2. è¿æ¥å¤ç”¨
```java
// ç›¸åŒhostå’Œportçš„è¯·æ±‚ï¼Œè‡ªåŠ¨å¤ç”¨è¿æ¥
Request req1 = new Request.Builder().url("http://api.com/users").build();
Request req2 = new Request.Builder().url("http://api.com/posts").build();
// ä¸¤ä¸ªè¯·æ±‚å¤ç”¨åŒä¸€ä¸ªTCPè¿æ¥ï¼
```
**æ•ˆæœ**ï¼šç¬¬äºŒä¸ªè¯·æ±‚å¿«50-70%

### 3. å¹¶å‘æ§åˆ¶
```java
Dispatcher dispatcher = client.dispatcher();
dispatcher.setMaxRequests(64);         // å…¨å±€æœ€å¤š64ä¸ªå¹¶å‘
dispatcher.setMaxRequestsPerHost(5);   // æ¯ä¸ªhostæœ€å¤š5ä¸ª
```

---

## ğŸ”§ å…³é”®APIé€ŸæŸ¥

### åˆ›å»ºè¯·æ±‚
```java
Request request = new Request.Builder()
    .url("http://example.com/api")
    .method("POST", body)  // GET/POST/PUT/DELETE
    .header("Authorization", "Bearer token")
    .addHeader("Custom", "value")
    .build();
```

### åŒæ­¥æ‰§è¡Œ
```java
try {
    Response response = client.newCall(request).execute();
    String body = response.body().string();
} catch (IOException e) {
    // å¤„ç†é”™è¯¯
}
```

### å¼‚æ­¥æ‰§è¡Œ
```java
client.newCall(request).enqueue(new Callback() {
    @Override
    public void onResponse(Call call, Response response) {
        // æˆåŠŸï¼ˆæ³¨æ„ï¼šåœ¨å­çº¿ç¨‹ï¼‰
    }
    
    @Override
    public void onFailure(Call call, IOException e) {
        // å¤±è´¥
    }
});
```

### åˆ›å»ºè¯·æ±‚ä½“
```java
// æ–‡æœ¬
RequestBody body = RequestBody.create("text", "text/plain");

// JSON
RequestBody json = RequestBody.create("{\"key\":\"value\"}", "application/json");

// è¡¨å•
RequestBody form = new FormBody.Builder()
    .add("username", "test")
    .add("password", "123")
    .build();
```

---

## ğŸ› å¸¸è§é”™è¯¯é€ŸæŸ¥

### 1. å¿˜è®°è°ƒç”¨chain.proceed()
```java
// âŒ é”™è¯¯
public Response intercept(Chain chain) {
    // å¿˜è®°è°ƒç”¨proceed()
    return null;  // è¯·æ±‚è¢«ç»ˆæ­¢ï¼
}

// âœ… æ­£ç¡®
public Response intercept(Chain chain) {
    return chain.proceed(chain.request());
}
```

### 2. ResponseBodyé‡å¤è¯»å–
```java
// âŒ é”™è¯¯
String body1 = response.body().string();
String body2 = response.body().string();  // æŠ›å‡ºå¼‚å¸¸ï¼

// âœ… æ­£ç¡®
String body = response.body().string();
// åªèƒ½è¯»å–ä¸€æ¬¡
```

### 3. ä¸»çº¿ç¨‹æ‰§è¡ŒåŒæ­¥è¯·æ±‚ï¼ˆAndroidï¼‰
```java
// âŒ é”™è¯¯ï¼šAndroidä¸»çº¿ç¨‹ä¼šå´©æºƒ
Response response = client.newCall(request).execute();

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å¼‚æ­¥
client.newCall(request).enqueue(callback);
```

### 4. å¿˜è®°å…³é—­ResponseBody
```java
// âŒ é”™è¯¯ï¼šèµ„æºæ³„æ¼
Response response = client.newCall(request).execute();
// ä½¿ç”¨åä¸å…³é—­

// âœ… æ­£ç¡®
Response response = client.newCall(request).execute();
try {
    String body = response.body().string();
} finally {
    response.close();
}
```

### 5. è¿æ¥æ± è¢«åƒåœ¾å›æ”¶
```java
// âŒ é”™è¯¯ï¼šå±€éƒ¨å˜é‡
void makeRequest() {
    OkHttpClient client = new OkHttpClient();
    client.newCall(request).execute();
}  // clientè¢«å›æ”¶ï¼Œè¿æ¥æ± å¤±æ•ˆ

// âœ… æ­£ç¡®ï¼šå…¨å±€å•ä¾‹
private static final OkHttpClient client = new OkHttpClient();
```

---

## ğŸ“Š HTTPçŠ¶æ€ç é€ŸæŸ¥

| çŠ¶æ€ç  | å«ä¹‰ | å¤„ç†æ–¹å¼ |
|--------|------|---------|
| 200 | æˆåŠŸ | æ­£å¸¸å¤„ç† |
| 301/302 | é‡å®šå‘ | RetryAndFollowUpè‡ªåŠ¨å¤„ç† |
| 401 | æœªæˆæƒ | æ£€æŸ¥Token |
| 404 | æœªæ‰¾åˆ° | æ£€æŸ¥URL |
| 408 | è¯·æ±‚è¶…æ—¶ | å¯ä»¥é‡è¯• |
| 500 | æœåŠ¡å™¨é”™è¯¯ | å¯ä»¥é‡è¯• |
| 502/503 | æœåŠ¡å™¨ä¸å¯ç”¨ | ç­‰å¾…åé‡è¯• |

---

## ğŸ“ é¢è¯•é«˜é¢‘é—®é¢˜

### Q1: OkHttpçš„æ‹¦æˆªå™¨æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ
**A**: ä½¿ç”¨è´£ä»»é“¾æ¨¡å¼ï¼Œé€šè¿‡RealInterceptorChainé€’å½’è°ƒç”¨æ¯ä¸ªæ‹¦æˆªå™¨ã€‚æ¯ä¸ªæ‹¦æˆªå™¨è°ƒç”¨chain.proceed()è§¦å‘ä¸‹ä¸€ä¸ªï¼Œå½¢æˆè°ƒç”¨é“¾ã€‚

### Q2: ä¸ºä»€ä¹ˆOkHttpæ€§èƒ½è¿™ä¹ˆå¥½ï¼Ÿ
**A**: 
1. è¿æ¥æ± å¤ç”¨TCPè¿æ¥ï¼Œè·³è¿‡ä¸‰æ¬¡æ¡æ‰‹
2. æ”¯æŒHTTP/2å’ŒGZIPå‹ç¼©
3. è‡ªåŠ¨å¤„ç†é‡è¯•å’Œé‡å®šå‘
4. é«˜æ•ˆçš„çº¿ç¨‹æ± ç®¡ç†

### Q3: è¿æ¥æ± æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ
**A**: 
1. ä½¿ç”¨å®Œçš„è¿æ¥ä¸å…³é—­ï¼Œæ”¾å…¥è¿æ¥æ± 
2. ä¸‹æ¬¡è¯·æ±‚æ—¶ï¼Œæ ¹æ®hostå’ŒportæŸ¥æ‰¾å¯å¤ç”¨çš„è¿æ¥
3. åå°çº¿ç¨‹å®šæœŸæ¸…ç†ç©ºé—²è¿æ¥ï¼ˆ5åˆ†é’Ÿè¶…æ—¶ï¼Œæœ€å¤š5ä¸ªï¼‰

### Q4: åŒæ­¥å’Œå¼‚æ­¥è¯·æ±‚çš„åŒºåˆ«ï¼Ÿ
**A**: 
- åŒæ­¥ï¼šexecute()ï¼Œé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´æ¥è¿”å›Response
- å¼‚æ­¥ï¼šenqueue()ï¼Œæäº¤åˆ°çº¿ç¨‹æ± æ‰§è¡Œï¼Œé€šè¿‡Callbackå›è°ƒç»“æœ

### Q5: å¦‚ä½•è‡ªå®šä¹‰æ‹¦æˆªå™¨ï¼Ÿ
**A**: 
```java
public class LoggingInterceptor implements Interceptor {
    @Override
    public Response intercept(Chain chain) throws IOException {
        Request request = chain.request();
        System.out.println("è¯·æ±‚: " + request.url());
        
        Response response = chain.proceed(request);
        
        System.out.println("å“åº”: " + response.code());
        return response;
    }
}

// æ·»åŠ æ‹¦æˆªå™¨
OkHttpClient client = new OkHttpClient.Builder()
    .addInterceptor(new LoggingInterceptor())
    .build();
```

---

## ğŸ’¡ å­¦ä¹ æŠ€å·§

### 1. ä»è¯·æ±‚æµç¨‹å…¥æ‰‹
```
åˆ›å»ºRequest â†’ newCall() â†’ execute()/enqueue()
â†’ æ‹¦æˆªå™¨é“¾ â†’ è¿”å›Response
```

### 2. é‡ç‚¹ç†è§£ä¸‰ä¸ªæ ¸å¿ƒ
- RealInterceptorChainï¼ˆé€’å½’è°ƒç”¨ï¼‰
- CallServerInterceptorï¼ˆHTTPåè®®ï¼‰
- ConnectionPoolï¼ˆè¿æ¥å¤ç”¨ï¼‰

### 3. ç”»å›¾è¾…åŠ©ç†è§£
- æ‹¦æˆªå™¨è°ƒç”¨æµç¨‹å›¾
- è¿æ¥æ± å·¥ä½œæµç¨‹å›¾
- å¼‚æ­¥è¯·æ±‚è°ƒåº¦æµç¨‹å›¾

### 4. å¯¹æ¯”å­¦ä¹ 
- å¯¹æ¯”å…¶ä»–HTTPåº“ï¼ˆRetrofitã€Volleyï¼‰
- å¯¹æ¯”çœŸå®OkHttpæºç 
- ç†è§£ç®€åŒ–ç‰ˆå’Œå®Œæ•´ç‰ˆçš„å·®å¼‚

---

## ğŸ“ æ£€æŸ¥æ¸…å•

- [ ] ç†è§£Builderæ¨¡å¼çš„ä¼˜ç‚¹
- [ ] èƒ½ç”»å‡ºæ‹¦æˆªå™¨è°ƒç”¨æµç¨‹
- [ ] ç†è§£HTTPè¯·æ±‚å’Œå“åº”æ ¼å¼
- [ ] çŸ¥é“\r\nçš„ä½œç”¨
- [ ] ç†è§£è¿æ¥å¤ç”¨çš„åŸç†
- [ ] ç†è§£å¼•ç”¨è®¡æ•°çš„ä½œç”¨
- [ ] çŸ¥é“ä¸ºä»€ä¹ˆéœ€è¦synchronized
- [ ] ç†è§£å®ˆæŠ¤çº¿ç¨‹vsç”¨æˆ·çº¿ç¨‹
- [ ] èƒ½è§£é‡ŠåŒæ­¥å’Œå¼‚æ­¥çš„åŒºåˆ«
- [ ] ç†è§£çº¿ç¨‹æ± çš„é…ç½®

---

**æ‰“å°æ­¤å¡ç‰‡ï¼Œè´´åœ¨æ¡Œä¸Šï¼Œéšæ—¶æŸ¥é˜…ï¼** ğŸ“Œ

