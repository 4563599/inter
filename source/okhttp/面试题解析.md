# OkHttp é¢è¯•é¢˜è§£æ

æ•´ç†äº†å¸¸è§çš„ OkHttp é¢è¯•é¢˜åŠè¯¦ç»†è§£ç­”ï¼Œå¸®åŠ©ä½ å‡†å¤‡é¢è¯•ã€‚

---

## ğŸ¯ åŸºç¡€æ¦‚å¿µ

### Q1: ä»€ä¹ˆæ˜¯ OkHttpï¼Ÿå®ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ

**ç­”æ¡ˆï¼š**

OkHttp æ˜¯ Square å…¬å¸å¼€æºçš„ä¸€ä¸ªé«˜æ•ˆçš„ HTTP å®¢æˆ·ç«¯åº“ã€‚

**è§£å†³çš„é—®é¢˜ï¼š**
1. **è¿æ¥å¤ç”¨**ï¼šé€šè¿‡è¿æ¥æ± å¤ç”¨ TCP è¿æ¥ï¼Œå‡å°‘å»¶è¿Ÿ
2. **é€æ˜çš„ Gzip å‹ç¼©**ï¼šèŠ‚çœå¸¦å®½
3. **å“åº”ç¼“å­˜**ï¼šé¿å…é‡å¤è¯·æ±‚
4. **è¯·æ±‚å¤±è´¥è‡ªåŠ¨é‡è¯•**ï¼šæé«˜å¯é æ€§
5. **æ”¯æŒ HTTP/2**ï¼šå¤šè·¯å¤ç”¨ã€æœåŠ¡å™¨æ¨é€ç­‰ç‰¹æ€§

**ä¸ HttpURLConnection å¯¹æ¯”ï¼š**
- OkHttp æ€§èƒ½æ›´å¥½ï¼ˆè¿æ¥æ± ã€HTTP/2ï¼‰
- API æ›´å‹å¥½ï¼ˆBuilder æ¨¡å¼ã€é“¾å¼è°ƒç”¨ï¼‰
- åŠŸèƒ½æ›´å¼ºå¤§ï¼ˆæ‹¦æˆªå™¨ã€ç¼“å­˜ã€é‡è¯•ï¼‰

---

### Q2: OkHttp çš„æ ¸å¿ƒç»„ä»¶æœ‰å“ªäº›ï¼Ÿ

**ç­”æ¡ˆï¼š**

1. **OkHttpClient**ï¼šHTTP å®¢æˆ·ç«¯ï¼Œç®¡ç†é…ç½®å’Œèµ„æº
2. **Request**ï¼šHTTP è¯·æ±‚å¯¹è±¡ï¼Œä¸å¯å˜
3. **Response**ï¼šHTTP å“åº”å¯¹è±¡ï¼Œä¸å¯å˜
4. **Call**ï¼šè¡¨ç¤ºä¸€ä¸ªå‡†å¤‡æ‰§è¡Œçš„è¯·æ±‚
5. **Interceptor**ï¼šæ‹¦æˆªå™¨ï¼Œå¤„ç†è¯·æ±‚å’Œå“åº”
6. **ConnectionPool**ï¼šè¿æ¥æ± ï¼Œç®¡ç† TCP è¿æ¥
7. **Dispatcher**ï¼šè°ƒåº¦å™¨ï¼Œç®¡ç†å¼‚æ­¥è¯·æ±‚

**å…³ç³»ï¼š**
```
OkHttpClient â†’ newCall(Request) â†’ Call â†’ execute()/enqueue()
    â†“                                        â†“
ConnectionPool                         Interceptor Chain
    â†“                                        â†“
Dispatcher                               Response
```

---

## ğŸ”¥ æ‹¦æˆªå™¨ç›¸å…³

### Q3: ä»€ä¹ˆæ˜¯æ‹¦æˆªå™¨ï¼ŸOkHttp çš„æ‹¦æˆªå™¨é“¾æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

**ç­”æ¡ˆï¼š**

**æ‹¦æˆªå™¨**æ˜¯ä¸€ç§è´£ä»»é“¾æ¨¡å¼çš„å®ç°ï¼Œæ¯ä¸ªæ‹¦æˆªå™¨éƒ½å¯ä»¥ï¼š
1. åœ¨è¯·æ±‚å‘é€å‰å¤„ç† Request
2. å†³å®šæ˜¯å¦ç»§ç»­é“¾çš„æ‰§è¡Œ
3. åœ¨å“åº”è¿”å›åå¤„ç† Response

**å·¥ä½œåŸç†ï¼š**
```java
// æ¯ä¸ªæ‹¦æˆªå™¨éƒ½å®ç°è¿™ä¸ªæ¥å£
interface Interceptor {
    Response intercept(Chain chain) throws IOException;
}

// å…¸å‹çš„æ‹¦æˆªå™¨å®ç°
class LoggingInterceptor implements Interceptor {
    @Override
    public Response intercept(Chain chain) throws IOException {
        Request request = chain.request();
        
        // 1. è¯·æ±‚å‰å¤„ç†
        System.out.println("å‘é€è¯·æ±‚: " + request.url());
        
        // 2. ç»§ç»­æ‰§è¡Œé“¾
        Response response = chain.proceed(request);
        
        // 3. å“åº”åå¤„ç†
        System.out.println("æ”¶åˆ°å“åº”: " + response.code());
        
        return response;
    }
}
```

**æ‰§è¡Œæµç¨‹ï¼š**
```
RealInterceptorChain.proceed(request, index=0)
    â†’ Interceptor[0].intercept(chain)
        â†’ chain.proceed(request)  // è°ƒç”¨ index=1 çš„é“¾
            â†’ Interceptor[1].intercept(chain)
                â†’ chain.proceed(request)  // è°ƒç”¨ index=2 çš„é“¾
                    â†’ ...
                        â†’ è¿”å› Response
                    â† å¤„ç† Response
                â† è¿”å› Response
            â† å¤„ç† Response
        â† è¿”å› Response
```

**å…³é”®ç‚¹ï¼š**
- æ¯æ¬¡ `proceed()` éƒ½åˆ›å»ºæ–°çš„ Chain å¯¹è±¡ï¼ˆindex + 1ï¼‰
- å½¢æˆé€’å½’è°ƒç”¨
- è¯·æ±‚ä»å¤–å‘å†…ï¼Œå“åº”ä»å†…å‘å¤–

---

### Q4: OkHttp æœ‰å“ªäº›å†…ç½®æ‹¦æˆªå™¨ï¼Ÿå®ƒä»¬çš„é¡ºåºä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

**ç­”æ¡ˆï¼š**

**å†…ç½®æ‹¦æˆªå™¨ï¼ˆæŒ‰é¡ºåºï¼‰ï¼š**
1. **Application Interceptors**ï¼ˆåº”ç”¨æ‹¦æˆªå™¨ï¼‰
2. **RetryAndFollowUpInterceptor**ï¼ˆé‡è¯•å’Œé‡å®šå‘ï¼‰
3. **BridgeInterceptor**ï¼ˆæ¡¥æ¥æ‹¦æˆªå™¨ï¼‰
4. **CacheInterceptor**ï¼ˆç¼“å­˜æ‹¦æˆªå™¨ï¼‰
5. **ConnectInterceptor**ï¼ˆè¿æ¥æ‹¦æˆªå™¨ï¼‰
6. **Network Interceptors**ï¼ˆç½‘ç»œæ‹¦æˆªå™¨ï¼‰
7. **CallServerInterceptor**ï¼ˆæœåŠ¡å™¨è°ƒç”¨æ‹¦æˆªå™¨ï¼‰

**ä¸ºä»€ä¹ˆè¿™ä¸ªé¡ºåºï¼Ÿ**

1. **Application Interceptors åœ¨æœ€å¤–å±‚**
   - å¯ä»¥çœ‹åˆ°å®Œæ•´çš„åŸå§‹è¯·æ±‚
   - ä¸å…³å¿ƒé‡å®šå‘å’Œé‡è¯•
   - åªè°ƒç”¨ä¸€æ¬¡

2. **RetryAndFollowUpInterceptor ç¬¬äºŒå±‚**
   - éœ€è¦åœ¨å…¶ä»–æ‹¦æˆªå™¨ä¹‹å‰å¤„ç†é‡è¯•
   - å¦‚æœå¤±è´¥ï¼Œå¯ä»¥é‡æ–°æ‰§è¡Œæ•´ä¸ªé“¾
   - å¤„ç† 3xx é‡å®šå‘

3. **BridgeInterceptor ç¬¬ä¸‰å±‚**
   - è¡¥å……å¿…è¦çš„ HTTP å¤´
   - å¦‚ Content-Type, Content-Length, User-Agent
   - å¤„ç† gzip å‹ç¼©

4. **CacheInterceptor ç¬¬å››å±‚**
   - åœ¨è¿æ¥ä¹‹å‰æ£€æŸ¥ç¼“å­˜
   - å¦‚æœæœ‰æœ‰æ•ˆç¼“å­˜ï¼Œç›´æ¥è¿”å›ï¼Œä¸éœ€è¦å»ºç«‹è¿æ¥
   - èŠ‚çœç½‘ç»œè¯·æ±‚

5. **ConnectInterceptor ç¬¬äº”å±‚**
   - å»ºç«‹ TCP è¿æ¥
   - ä»è¿æ¥æ± è·å–æˆ–åˆ›å»ºè¿æ¥
   - è¿™æ˜¯åº”ç”¨å±‚å’Œç½‘ç»œå±‚çš„åˆ†ç•Œç‚¹

6. **Network Interceptors ç¬¬å…­å±‚**
   - åœ¨çœŸå®ç½‘ç»œè¯·æ±‚ä¹‹å‰
   - å¯ä»¥çœ‹åˆ°å®é™…å‘é€åˆ°æœåŠ¡å™¨çš„è¯·æ±‚
   - å¯èƒ½è¢«è°ƒç”¨å¤šæ¬¡ï¼ˆé‡è¯•ï¼‰

7. **CallServerInterceptor æœ€å†…å±‚**
   - æ‰§è¡ŒçœŸå®çš„ç½‘ç»œ I/O
   - å‘é€è¯·æ±‚ï¼Œè¯»å–å“åº”
   - ä¸èƒ½å†è°ƒç”¨ `chain.proceed()`

**å›¾è§£ï¼š**
```
ç”¨æˆ·è¯·æ±‚
    â†“
[Application] - å®Œæ•´çš„åŸå§‹è¯·æ±‚
    â†“
[Retry] - å¤„ç†é‡è¯•å’Œé‡å®šå‘
    â†“
[Bridge] - è¡¥å…… HTTP å¤´
    â†“
[Cache] - æ£€æŸ¥ç¼“å­˜
    â†“
[Connect] - å»ºç«‹è¿æ¥
    â†“
[Network] - çœŸå®ç½‘ç»œè¯·æ±‚å‰
    â†“
[CallServer] - æ‰§è¡Œç½‘ç»œ I/O
    â†“
æœåŠ¡å™¨
```

---

### Q5: Application Interceptor å’Œ Network Interceptor æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**ç­”æ¡ˆï¼š**

| ç‰¹æ€§ | Application Interceptor | Network Interceptor |
|------|------------------------|-------------------|
| ä½ç½® | æœ€å¤–å±‚ | ConnectInterceptor ä¹‹å |
| è°ƒç”¨æ¬¡æ•° | åªè°ƒç”¨ä¸€æ¬¡ | å¯èƒ½å¤šæ¬¡ï¼ˆé‡è¯•ã€é‡å®šå‘ï¼‰ |
| çœ‹åˆ°çš„è¯·æ±‚ | åŸå§‹è¯·æ±‚ | å®é™…å‘é€åˆ°æœåŠ¡å™¨çš„è¯·æ±‚ |
| çœ‹åˆ°çš„å“åº” | æœ€ç»ˆå“åº” | å®é™…ä»æœåŠ¡å™¨è¿”å›çš„å“åº” |
| è®¿é—®è¿æ¥ä¿¡æ¯ | å¦ | æ˜¯ |
| ç¼“å­˜ | åœ¨ç¼“å­˜ä¹‹å‰ | åœ¨ç¼“å­˜ä¹‹å |

**ç¤ºä¾‹ï¼š**

å‡è®¾è¯·æ±‚è¢«é‡å®šå‘äº†ä¸€æ¬¡ï¼š

```
Application Interceptor:
  - çœ‹åˆ°ï¼š1 ä¸ªè¯·æ±‚ï¼ˆåŸå§‹è¯·æ±‚ï¼‰
  - çœ‹åˆ°ï¼š1 ä¸ªå“åº”ï¼ˆæœ€ç»ˆå“åº”ï¼‰

Network Interceptor:
  - çœ‹åˆ°ï¼š2 ä¸ªè¯·æ±‚ï¼ˆåŸå§‹ + é‡å®šå‘ï¼‰
  - çœ‹åˆ°ï¼š2 ä¸ªå“åº”ï¼ˆ301 + æœ€ç»ˆå“åº”ï¼‰
```

**ä½¿ç”¨åœºæ™¯ï¼š**

**Application Interceptorï¼š**
- æ·»åŠ è‡ªå®šä¹‰è¯·æ±‚å¤´ï¼ˆå¦‚ Tokenï¼‰
- è®°å½•è¯·æ±‚æ—¥å¿—
- ä¸å…³å¿ƒ OkHttp çš„å†…éƒ¨è¡Œä¸º

**Network Interceptorï¼š**
- è®°å½•ç½‘ç»œä¼ è¾“çš„æ•°æ®é‡
- è®¿é—®è¿æ¥ä¿¡æ¯
- é‡å†™è¯·æ±‚åˆ°æœåŠ¡å™¨çš„æ•°æ®

---

## ğŸ”— è¿æ¥æ± ç›¸å…³

### Q6: OkHttp çš„è¿æ¥æ± æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

**ç­”æ¡ˆï¼š**

**æ ¸å¿ƒæ€æƒ³ï¼š**
- HTTP/1.1 æ”¯æŒ Keep-Aliveï¼Œå¯ä»¥åœ¨ä¸€ä¸ª TCP è¿æ¥ä¸Šå‘é€å¤šä¸ªè¯·æ±‚
- å»ºç«‹ TCP è¿æ¥å¾ˆè€—æ—¶ï¼ˆä¸‰æ¬¡æ¡æ‰‹ + TLS æ¡æ‰‹ï¼‰
- è¿æ¥æ± å¤ç”¨è¿æ¥ï¼Œæ˜¾è‘—æå‡æ€§èƒ½

**å·¥ä½œæµç¨‹ï¼š**

```
1. éœ€è¦è¿æ¥æ—¶
   â†“
2. ä»è¿æ¥æ± æŸ¥æ‰¾å¯å¤ç”¨çš„è¿æ¥
   â”œâ”€ host å’Œ port åŒ¹é…
   â”œâ”€ è¿æ¥æœªå…³é—­
   â””â”€ è¿æ¥æœªè¢«å ç”¨
   â†“
3. æ‰¾åˆ°äº†ï¼Ÿ
   â”œâ”€ æ˜¯ï¼šå¤ç”¨è¿æ¥ï¼ˆå¼•ç”¨è®¡æ•° +1ï¼‰
   â””â”€ å¦ï¼šåˆ›å»ºæ–°è¿æ¥
   â†“
4. ä½¿ç”¨è¿æ¥å‘é€è¯·æ±‚
   â†“
5. ä½¿ç”¨å®Œæ¯•ï¼Œæ”¾å›è¿æ¥æ± ï¼ˆå¼•ç”¨è®¡æ•° -1ï¼‰
   â†“
6. åå°æ¸…ç†çº¿ç¨‹å®šæœŸæ¸…ç†ç©ºé—²è¿æ¥
```

**å¼•ç”¨è®¡æ•°ï¼š**
```java
class RealConnection {
    private int referenceCount = 0;  // å¼•ç”¨è®¡æ•°
    private long idleAtNanos;        // ç©ºé—²å¼€å§‹æ—¶é—´
    
    void acquire() {
        referenceCount++;  // å¼€å§‹ä½¿ç”¨
    }
    
    void release() {
        referenceCount--;  // ä½¿ç”¨å®Œæ¯•
        if (referenceCount == 0) {
            idleAtNanos = System.nanoTime();
        }
    }
}
```

**æ¸…ç†ç­–ç•¥ï¼š**
- é»˜è®¤ä¿æŒ 5 ä¸ªç©ºé—²è¿æ¥
- ç©ºé—²è¿æ¥ä¿æŒ 5 åˆ†é’Ÿ
- è¶…è¿‡æ—¶é—´æˆ–æ•°é‡ï¼Œå…³é—­æœ€è€çš„è¿æ¥

**ä»£ç ç¤ºä¾‹ï¼š**
```java
// é»˜è®¤è¿æ¥æ± 
ConnectionPool pool = new ConnectionPool();

// è‡ªå®šä¹‰ï¼šä¿æŒ10ä¸ªè¿æ¥ï¼Œæ¯ä¸ªä¿æŒ10åˆ†é’Ÿ
ConnectionPool customPool = new ConnectionPool(
    10,                    // maxIdleConnections
    10,                    // keepAliveDuration
    TimeUnit.MINUTES       // unit
);
```

---

### Q7: ä¸ºä»€ä¹ˆè¿æ¥æ± èƒ½æå‡æ€§èƒ½ï¼Ÿå…·ä½“æå‡å¤šå°‘ï¼Ÿ

**ç­”æ¡ˆï¼š**

**å»ºç«‹ TCP è¿æ¥çš„å¼€é”€ï¼š**

1. **TCP ä¸‰æ¬¡æ¡æ‰‹**
   - Client â†’ Server: SYN
   - Server â†’ Client: SYN-ACK
   - Client â†’ Server: ACK
   - è‡³å°‘éœ€è¦ 1.5 ä¸ª RTTï¼ˆå¾€è¿”æ—¶é—´ï¼‰

2. **TLS æ¡æ‰‹ï¼ˆHTTPSï¼‰**
   - éœ€è¦é¢å¤– 2 ä¸ª RTT
   - äº¤æ¢è¯ä¹¦ã€å¯†é’¥ç­‰

3. **æ€»è€—æ—¶**
   - HTTPï¼šçº¦ 1.5 RTT = 50-100msï¼ˆå–å†³äºç½‘ç»œï¼‰
   - HTTPSï¼šçº¦ 3.5 RTT = 150-300ms

**å¤ç”¨è¿æ¥çš„å¥½å¤„ï¼š**
- è·³è¿‡æ¡æ‰‹è¿‡ç¨‹
- ç›´æ¥å‘é€è¯·æ±‚
- è€—æ—¶å‡ ä¹ä¸º 0

**æ€§èƒ½å¯¹æ¯”ï¼š**

```
ä¸ä½¿ç”¨è¿æ¥æ± ï¼š
è¯·æ±‚1ï¼š100msï¼ˆå»ºç«‹è¿æ¥ï¼‰+ 50msï¼ˆè¯·æ±‚ï¼‰= 150ms
è¯·æ±‚2ï¼š100msï¼ˆå»ºç«‹è¿æ¥ï¼‰+ 50msï¼ˆè¯·æ±‚ï¼‰= 150ms
è¯·æ±‚3ï¼š100msï¼ˆå»ºç«‹è¿æ¥ï¼‰+ 50msï¼ˆè¯·æ±‚ï¼‰= 150ms
æ€»è®¡ï¼š450ms

ä½¿ç”¨è¿æ¥æ± ï¼š
è¯·æ±‚1ï¼š100msï¼ˆå»ºç«‹è¿æ¥ï¼‰+ 50msï¼ˆè¯·æ±‚ï¼‰= 150ms
è¯·æ±‚2ï¼š0msï¼ˆå¤ç”¨è¿æ¥ï¼‰+ 50msï¼ˆè¯·æ±‚ï¼‰= 50ms
è¯·æ±‚3ï¼š0msï¼ˆå¤ç”¨è¿æ¥ï¼‰+ 50msï¼ˆè¯·æ±‚ï¼‰= 50ms
æ€»è®¡ï¼š250ms

æå‡ï¼š(450-250)/450 = 44%
```

**çœŸå®æµ‹è¯•ç»“æœï¼š**
- å±€åŸŸç½‘ï¼šæå‡ 30-50%
- å¤–ç½‘ï¼šæå‡ 50-70%
- HTTPSï¼šæå‡æ›´æ˜æ˜¾ï¼ˆå› ä¸º TLS æ¡æ‰‹æ›´è€—æ—¶ï¼‰

---

## ğŸ”„ å¼‚æ­¥ä¸å¹¶å‘

### Q8: OkHttp çš„åŒæ­¥è¯·æ±‚å’Œå¼‚æ­¥è¯·æ±‚æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**ç­”æ¡ˆï¼š**

**åŒæ­¥è¯·æ±‚ï¼ˆexecuteï¼‰ï¼š**
```java
try {
    Response response = client.newCall(request).execute();
    // åœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œï¼Œé˜»å¡ç›´åˆ°è·å¾—å“åº”
} catch (IOException e) {
    // å¤„ç†å¼‚å¸¸
}
```

**ç‰¹ç‚¹ï¼š**
- é˜»å¡å½“å‰çº¿ç¨‹
- åœ¨è°ƒç”¨çº¿ç¨‹ä¸­æ‰§è¡Œ
- è¿”å› Response æˆ–æŠ›å‡ºå¼‚å¸¸
- é€‚åˆåå°çº¿ç¨‹

**å¼‚æ­¥è¯·æ±‚ï¼ˆenqueueï¼‰ï¼š**
```java
client.newCall(request).enqueue(new Callback() {
    @Override
    public void onResponse(Call call, Response response) {
        // åœ¨å·¥ä½œçº¿ç¨‹å›è°ƒ
    }
    
    @Override
    public void onFailure(Call call, IOException e) {
        // åœ¨å·¥ä½œçº¿ç¨‹å›è°ƒ
    }
});
// ç«‹å³è¿”å›ï¼Œä¸é˜»å¡
```

**ç‰¹ç‚¹ï¼š**
- ä¸é˜»å¡å½“å‰çº¿ç¨‹
- æäº¤åˆ° Dispatcher çš„çº¿ç¨‹æ± 
- é€šè¿‡å›è°ƒè¿”å›ç»“æœ
- å›è°ƒåœ¨å·¥ä½œçº¿ç¨‹ï¼Œä¸æ˜¯ä¸»çº¿ç¨‹
- é€‚åˆ UI çº¿ç¨‹

**å¯¹æ¯”ï¼š**

| ç‰¹æ€§ | execute | enqueue |
|------|---------|---------|
| é˜»å¡ | æ˜¯ | å¦ |
| çº¿ç¨‹ | å½“å‰çº¿ç¨‹ | å·¥ä½œçº¿ç¨‹ |
| è¿”å›æ–¹å¼ | ç›´æ¥è¿”å› | å›è°ƒ |
| é€‚ç”¨åœºæ™¯ | åå°çº¿ç¨‹ | UI çº¿ç¨‹ |
| å–æ¶ˆ | éœ€è¦ä¸­æ–­çº¿ç¨‹ | è°ƒç”¨ cancel() |

---

### Q9: Dispatcher æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿå¦‚ä½•æ§åˆ¶å¹¶å‘æ•°é‡ï¼Ÿ

**ç­”æ¡ˆï¼š**

**Dispatcher çš„èŒè´£ï¼š**
1. ç®¡ç†çº¿ç¨‹æ± 
2. æ§åˆ¶å¹¶å‘è¯·æ±‚æ•°é‡
3. ç®¡ç†ç­‰å¾…é˜Ÿåˆ—
4. å¤„ç†è¯·æ±‚å®Œæˆåçš„æ¸…ç†

**æ•°æ®ç»“æ„ï¼š**
```java
class Dispatcher {
    // æœ€å¤§å¹¶å‘è¯·æ±‚æ•°
    private int maxRequests = 64;
    
    // æ¯ä¸ª host çš„æœ€å¤§å¹¶å‘æ•°
    private int maxRequestsPerHost = 5;
    
    // çº¿ç¨‹æ± 
    private ExecutorService executorService;
    
    // æ­£åœ¨è¿è¡Œçš„å¼‚æ­¥è¯·æ±‚
    private final Deque<AsyncCall> runningAsyncCalls;
    
    // ç­‰å¾…æ‰§è¡Œçš„å¼‚æ­¥è¯·æ±‚
    private final Deque<AsyncCall> readyAsyncCalls;
    
    // æ­£åœ¨è¿è¡Œçš„åŒæ­¥è¯·æ±‚
    private final Deque<RealCall> runningSyncCalls;
}
```

**å·¥ä½œæµç¨‹ï¼š**

```
1. æäº¤å¼‚æ­¥è¯·æ±‚
   â†“
2. dispatcher.enqueue(asyncCall)
   â†“
3. æ£€æŸ¥å¹¶å‘æ•°
   â”œâ”€ runningAsyncCalls.size() < maxRequests?
   â”‚  â”œâ”€ æ˜¯ï¼š
   â”‚  â”‚  â”œâ”€ runningAsyncCalls.add(call)
   â”‚  â”‚  â””â”€ executorService.execute(call)  // ç«‹å³æ‰§è¡Œ
   â”‚  â””â”€ å¦ï¼š
   â”‚     â””â”€ readyAsyncCalls.add(call)  // åŠ å…¥ç­‰å¾…é˜Ÿåˆ—
   â†“
4. è¯·æ±‚æ‰§è¡Œå®Œæˆ
   â†“
5. dispatcher.finished(asyncCall)
   â†“
6. promoteAndExecute()  // ä»ç­‰å¾…é˜Ÿåˆ—å–ä¸‹ä¸€ä¸ª
```

**çº¿ç¨‹æ± é…ç½®ï¼š**
```java
executorService = new ThreadPoolExecutor(
    0,                      // æ ¸å¿ƒçº¿ç¨‹æ•°ï¼š0ï¼ˆåŠ¨æ€åˆ›å»ºï¼‰
    Integer.MAX_VALUE,      // æœ€å¤§çº¿ç¨‹æ•°ï¼šæ— é™åˆ¶
    60,                     // ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ï¼š60ç§’
    TimeUnit.SECONDS,
    new SynchronousQueue<>(),  // æ— ç¼“å†²é˜Ÿåˆ—
    threadFactory("OkHttp Dispatcher")
);
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**
- æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º 0ï¼šèŠ‚çœèµ„æºï¼ŒæŒ‰éœ€åˆ›å»º
- æœ€å¤§çº¿ç¨‹æ•°æ— é™åˆ¶ï¼šä¾é  `maxRequests` æ§åˆ¶å¹¶å‘
- SynchronousQueueï¼šä¸ç¼“å­˜ä»»åŠ¡ï¼Œç›´æ¥äº¤ç»™çº¿ç¨‹
- 60 ç§’è¶…æ—¶ï¼šç©ºé—²çº¿ç¨‹è‡ªåŠ¨å›æ”¶

**å¹¶å‘æ§åˆ¶ï¼š**
```
maxRequests = 64          â† å…¨å±€æœ€å¤§å¹¶å‘æ•°
maxRequestsPerHost = 5    â† å•ä¸ª host æœ€å¤§å¹¶å‘æ•°

ä¾‹å¦‚ï¼š
- www.example.com: 5 ä¸ªè¯·æ±‚
- api.example.com: 5 ä¸ªè¯·æ±‚
- cdn.example.com: 5 ä¸ªè¯·æ±‚
- ...
æ€»è®¡ï¼šæœ€å¤š 64 ä¸ªå¹¶å‘è¯·æ±‚
```

---

## ğŸ¨ è®¾è®¡æ¨¡å¼

### Q10: OkHttp ä½¿ç”¨äº†å“ªäº›è®¾è®¡æ¨¡å¼ï¼Ÿ

**ç­”æ¡ˆï¼š**

**1. Builder æ¨¡å¼**
```java
OkHttpClient client = new OkHttpClient.Builder()
    .connectTimeout(10, TimeUnit.SECONDS)
    .readTimeout(10, TimeUnit.SECONDS)
    .addInterceptor(loggingInterceptor)
    .build();

Request request = new Request.Builder()
    .url("https://example.com")
    .header("Authorization", "Bearer token")
    .post(body)
    .build();
```

**ä¼˜ç‚¹ï¼š**
- é“¾å¼è°ƒç”¨ï¼Œå¯è¯»æ€§å¼º
- å‚æ•°å¯é€‰ï¼Œçµæ´»é…ç½®
- å¯¹è±¡ä¸å¯å˜ï¼Œçº¿ç¨‹å®‰å…¨

**2. è´£ä»»é“¾æ¨¡å¼**
```java
// æ‹¦æˆªå™¨é“¾
interface Interceptor {
    Response intercept(Chain chain) throws IOException;
}

// æ¯ä¸ªæ‹¦æˆªå™¨å¤„ç†åä¼ é€’ç»™ä¸‹ä¸€ä¸ª
Response intercept(Chain chain) {
    Request request = chain.request();
    // å¤„ç†è¯·æ±‚
    Response response = chain.proceed(request);
    // å¤„ç†å“åº”
    return response;
}
```

**ä¼˜ç‚¹ï¼š**
- è§£è€¦è¯·æ±‚å‘é€è€…å’Œæ¥æ”¶è€…
- åŠ¨æ€ç»„åˆæ‹¦æˆªå™¨
- æ˜“äºæ‰©å±•

**3. å·¥å‚æ¨¡å¼**
```java
// OkHttpClient ä½œä¸ºå·¥å‚åˆ›å»º Call
Call call = client.newCall(request);
```

**ä¼˜ç‚¹ï¼š**
- å°è£…å¯¹è±¡åˆ›å»ºé€»è¾‘
- è°ƒç”¨è€…ä¸å…³å¿ƒå®ç°ç»†èŠ‚

**4. å•ä¾‹æ¨¡å¼**
```java
// é€šå¸¸ä¸€ä¸ªåº”ç”¨åªéœ€è¦ä¸€ä¸ª OkHttpClient å®ä¾‹
public class HttpClient {
    private static final OkHttpClient instance = new OkHttpClient();
    
    public static OkHttpClient getInstance() {
        return instance;
    }
}
```

**ä¼˜ç‚¹ï¼š**
- å…±äº«èµ„æºï¼ˆè¿æ¥æ± ã€çº¿ç¨‹æ± ï¼‰
- èŠ‚çœå†…å­˜

**5. ç­–ç•¥æ¨¡å¼**
```java
// ä¸åŒçš„ç¼“å­˜ç­–ç•¥
interface CacheStrategy {
    Response getFromCache();
    void saveToCache(Response response);
}
```

**ä¼˜ç‚¹ï¼š**
- ç®—æ³•å¯ä»¥äº’ç›¸æ›¿æ¢
- æ˜“äºæ‰©å±•æ–°ç­–ç•¥

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### Q11: å¦‚ä½•ä¼˜åŒ– OkHttp çš„æ€§èƒ½ï¼Ÿ

**ç­”æ¡ˆï¼š**

**1. å¤ç”¨ OkHttpClient å®ä¾‹**
```java
// âŒ ä¸å¥½ï¼šæ¯æ¬¡éƒ½åˆ›å»ºæ–°å®ä¾‹
public Response request() {
    OkHttpClient client = new OkHttpClient();
    return client.newCall(request).execute();
}

// âœ… å¥½ï¼šå¤ç”¨å®ä¾‹
public class HttpClient {
    private static final OkHttpClient client = new OkHttpClient();
    
    public Response request() {
        return client.newCall(request).execute();
    }
}
```

**åŸå› ï¼š**
- OkHttpClient å†…éƒ¨ç»´æŠ¤äº†è¿æ¥æ± å’Œçº¿ç¨‹æ± 
- åˆ›å»ºæ–°å®ä¾‹æ— æ³•å¤ç”¨è¿æ¥
- æµªè´¹èµ„æº

**2. é…ç½®åˆç†çš„è¿æ¥æ± **
```java
OkHttpClient client = new OkHttpClient.Builder()
    .connectionPool(new ConnectionPool(
        10,                    // ä¿æŒ 10 ä¸ªç©ºé—²è¿æ¥
        10,                    // ä¿æŒ 10 åˆ†é’Ÿ
        TimeUnit.MINUTES
    ))
    .build();
```

**æ ¹æ®ä¸šåŠ¡è°ƒæ•´ï¼š**
- é«˜å¹¶å‘ï¼šå¢åŠ  maxIdleConnections
- é•¿æ—¶é—´æ— è¯·æ±‚ï¼šå‡å°‘ keepAliveDuration

**3. åˆç†è®¾ç½®è¶…æ—¶**
```java
OkHttpClient client = new OkHttpClient.Builder()
    .connectTimeout(10, TimeUnit.SECONDS)   // è¿æ¥è¶…æ—¶
    .readTimeout(30, TimeUnit.SECONDS)      // è¯»å–è¶…æ—¶
    .writeTimeout(30, TimeUnit.SECONDS)     // å†™å…¥è¶…æ—¶
    .build();
```

**æ ¹æ®ä¸šåŠ¡è°ƒæ•´ï¼š**
- å¿«é€Ÿæ¥å£ï¼šè¾ƒçŸ­è¶…æ—¶
- å¤§æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½ï¼šè¾ƒé•¿è¶…æ—¶

**4. ä½¿ç”¨ Gzip å‹ç¼©**
```java
// OkHttp é»˜è®¤å¯ç”¨ gzip
// è‡ªåŠ¨æ·»åŠ  Accept-Encoding: gzip
// è‡ªåŠ¨è§£å‹å“åº”
```

**æ•ˆæœï¼š**
- æ–‡æœ¬å†…å®¹å‹ç¼©ç‡ 70-90%
- æ˜¾è‘—å‡å°‘ä¼ è¾“æ—¶é—´

**5. å¯ç”¨ HTTP/2**
```java
// OkHttp è‡ªåŠ¨æ”¯æŒ HTTP/2
// æ— éœ€é¢å¤–é…ç½®
```

**ä¼˜åŠ¿ï¼š**
- å¤šè·¯å¤ç”¨ï¼šä¸€ä¸ªè¿æ¥å¹¶å‘å¤šä¸ªè¯·æ±‚
- å¤´éƒ¨å‹ç¼©ï¼šå‡å°‘ä¼ è¾“é‡
- æœåŠ¡å™¨æ¨é€

**6. åˆç†ä½¿ç”¨ç¼“å­˜**
```java
OkHttpClient client = new OkHttpClient.Builder()
    .cache(new Cache(cacheDirectory, 10 * 1024 * 1024))  // 10MB
    .build();
```

**å¥½å¤„ï¼š**
- é¿å…é‡å¤è¯·æ±‚
- ç¦»çº¿å¯ç”¨
- èŠ‚çœæµé‡

**7. æ‰¹é‡è¯·æ±‚**
```java
// å¦‚æœéœ€è¦å¤šä¸ªè¯·æ±‚ï¼Œè€ƒè™‘æ‰¹é‡æ¥å£
// å‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°
```

**8. é¢„è¿æ¥ï¼ˆDNS é¢„è§£æï¼‰**
```java
// åœ¨éœ€è¦ä¹‹å‰å»ºç«‹è¿æ¥
executorService.execute(() -> {
    try {
        client.newCall(request).execute().close();
    } catch (IOException e) {
        // å¿½ç•¥
    }
});
```

---

## ğŸ’» å®æˆ˜é—®é¢˜

### Q12: å¦‚ä½•å®ç°è¯·æ±‚çš„å…¨å±€ç»Ÿä¸€è®¤è¯ï¼Ÿ

**ç­”æ¡ˆï¼š**

**æ–¹æ³•1ï¼šä½¿ç”¨ Interceptor**
```java
class AuthInterceptor implements Interceptor {
    @Override
    public Response intercept(Chain chain) throws IOException {
        Request original = chain.request();
        
        // æ·»åŠ è®¤è¯å¤´
        Request authorized = original.newBuilder()
            .header("Authorization", "Bearer " + getToken())
            .build();
        
        Response response = chain.proceed(authorized);
        
        // å¦‚æœ 401ï¼Œåˆ·æ–° token å¹¶é‡è¯•
        if (response.code() == 401) {
            synchronized (this) {
                String newToken = refreshToken();
                
                Request newRequest = original.newBuilder()
                    .header("Authorization", "Bearer " + newToken)
                    .build();
                
                return chain.proceed(newRequest);
            }
        }
        
        return response;
    }
    
    private String getToken() {
        // ä»ç¼“å­˜æˆ–å­˜å‚¨ä¸­è·å– token
        return TokenManager.getInstance().getToken();
    }
    
    private String refreshToken() {
        // åˆ·æ–° token çš„é€»è¾‘
        return TokenManager.getInstance().refreshToken();
    }
}

// ä½¿ç”¨
OkHttpClient client = new OkHttpClient.Builder()
    .addInterceptor(new AuthInterceptor())
    .build();
```

---

### Q13: å¦‚ä½•å®ç°è¯·æ±‚çš„æ—¥å¿—è®°å½•ï¼Ÿ

**ç­”æ¡ˆï¼š**

**æ–¹æ³•1ï¼šä½¿ç”¨ HttpLoggingInterceptorï¼ˆå®˜æ–¹æä¾›ï¼‰**
```java
HttpLoggingInterceptor logging = new HttpLoggingInterceptor();
logging.setLevel(HttpLoggingInterceptor.Level.BODY);

OkHttpClient client = new OkHttpClient.Builder()
    .addInterceptor(logging)
    .build();
```

**æ–¹æ³•2ï¼šè‡ªå®šä¹‰æ—¥å¿—æ‹¦æˆªå™¨**
```java
class LoggingInterceptor implements Interceptor {
    @Override
    public Response intercept(Chain chain) throws IOException {
        Request request = chain.request();
        
        // è®°å½•è¯·æ±‚
        System.out.println("========== REQUEST ==========");
        System.out.println("URL: " + request.url());
        System.out.println("Method: " + request.method());
        System.out.println("Headers: " + request.headers());
        
        long startTime = System.nanoTime();
        Response response = chain.proceed(request);
        long duration = TimeUnit.NANOSECONDS.toMillis(
            System.nanoTime() - startTime
        );
        
        // è®°å½•å“åº”
        System.out.println("========== RESPONSE ==========");
        System.out.println("Code: " + response.code());
        System.out.println("Duration: " + duration + "ms");
        System.out.println("Headers: " + response.headers());
        
        return response;
    }
}
```

---

### Q14: å¦‚ä½•å–æ¶ˆæ­£åœ¨æ‰§è¡Œçš„è¯·æ±‚ï¼Ÿ

**ç­”æ¡ˆï¼š**

**åŒæ­¥è¯·æ±‚å–æ¶ˆï¼š**
```java
final Call call = client.newCall(request);

// åœ¨å¦ä¸€ä¸ªçº¿ç¨‹å–æ¶ˆ
new Thread(() -> {
    try {
        Thread.sleep(1000);
        call.cancel();  // å–æ¶ˆè¯·æ±‚
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
}).start();

try {
    Response response = call.execute();
} catch (IOException e) {
    if (call.isCanceled()) {
        System.out.println("è¯·æ±‚è¢«å–æ¶ˆ");
    }
}
```

**å¼‚æ­¥è¯·æ±‚å–æ¶ˆï¼š**
```java
Call call = client.newCall(request);

call.enqueue(new Callback() {
    @Override
    public void onFailure(Call call, IOException e) {
        if (call.isCanceled()) {
            System.out.println("è¯·æ±‚è¢«å–æ¶ˆ");
        }
    }
    
    @Override
    public void onResponse(Call call, Response response) {
        System.out.println("è¯·æ±‚æˆåŠŸ");
    }
});

// å–æ¶ˆè¯·æ±‚
call.cancel();
```

**å–æ¶ˆæ‰€æœ‰è¯·æ±‚ï¼š**
```java
client.dispatcher().cancelAll();
```

---

## ğŸ“ è¿›é˜¶é—®é¢˜

### Q15: OkHttp å¦‚ä½•å¤„ç† Cookieï¼Ÿ

**ç­”æ¡ˆï¼š**

**OkHttp é»˜è®¤ä¸è‡ªåŠ¨ç®¡ç† Cookie**ï¼Œéœ€è¦æ‰‹åŠ¨å®ç°ã€‚

**æ–¹æ³•1ï¼šæ‰‹åŠ¨å¤„ç†**
```java
// ä¿å­˜ Cookie
Response response = client.newCall(request).execute();
List<String> cookies = response.headers("Set-Cookie");

// å‘é€ Cookie
Request request = new Request.Builder()
    .url("https://example.com")
    .header("Cookie", cookies.get(0))
    .build();
```

**æ–¹æ³•2ï¼šä½¿ç”¨ CookieJar**
```java
class MyCookieJar implements CookieJar {
    private final Map<String, List<Cookie>> cookieStore = new HashMap<>();
    
    @Override
    public void saveFromResponse(HttpUrl url, List<Cookie> cookies) {
        cookieStore.put(url.host(), cookies);
    }
    
    @Override
    public List<Cookie> loadForRequest(HttpUrl url) {
        List<Cookie> cookies = cookieStore.get(url.host());
        return cookies != null ? cookies : new ArrayList<>();
    }
}

OkHttpClient client = new OkHttpClient.Builder()
    .cookieJar(new MyCookieJar())
    .build();
```

---

**æŒæ¡è¿™äº›é¢è¯•é¢˜ï¼Œä½ å°±èƒ½ä»å®¹åº”å¯¹ OkHttp ç›¸å…³çš„é¢è¯•äº†ï¼** ğŸ¯

